###############################################################################
##                                                                          ###
##                              .gitattributes                              ###
##                                                                          ###
###############################################################################

# Auto detect text files and perform LF normalization
* text=auto


###############################################################################
##                                                                          ###
##                             actor-sheet.html                             ###
##                                                                          ###
###############################################################################

<form class="{{cssClass}} {{actor.type}}" autocomplete="off">

    {{!-- ================================================================= --}}
    {{!-- SHEET HEADER: Avatar, Name, Resources, Rest, Combat Utils         --}}
    {{!-- ================================================================= --}}
    <header class="sheet-header">
        <img class="profile-img" src="{{actor.img}}" data-edit="img" title="{{actor.name}}" height="100" width="100"/>
        <div class="header-fields">
            <h1 class="charname"><input name="name" type="text" value="{{actor.name}}" placeholder="Name"/></h1>
            
            <div class="resource-row">
                {{!-- 1. Active Vigor (HP) --}}
                <div class="resource">
                    <label>{{localize "NAREQUENTA.EssenceCur"}} / HP</label>
                    <input type="number" name="system.resources.hp.value" value="{{systemData.resources.hp.value}}" style="width: 50px;">
                    <span> / </span>
                    <input type="number" name="system.resources.hp.max" value="{{systemData.resources.hp.max}}" style="width: 50px;">
                </div>

                {{!-- 2. Action Surges (PC Only) with Use Button --}}
                {{#if (eq actor.type "character")}}
                <div class="resource">
                    <label>{{localize "NAREQUENTA.ActionSurges"}}</label>
                    <input type="number" name="system.resources.action_surges.value" value="{{systemData.resources.action_surges.value}}" style="width: 40px;">
                    <span> / </span>
                    <span class="derived-stat" style="font-weight: bold; font-size: 1.2em;">{{systemData.resources.action_surges.max}}</span>
                    
                    {{!-- Use Action Surge Button (Lightning) --}}
                    <a class="use-action-surge" title="Use Action Surge" style="margin-left: 8px; color: #d4af37; cursor: pointer;">
                        <i class="fas fa-bolt"></i>
                    </a>
                </div>
                {{/if}}

                {{!-- 3. Utility Buttons --}}
                <div class="resource" style="display: flex; gap: 5px; align-items: flex-end;">
                    <a class="rest-btn end-turn" title="End Turn"><i class="fas fa-step-forward"></i> End Turn</a>
                    <a class="rest-btn short-rest" title="Refocus"><i class="fas fa-coffee"></i> Short</a>
                    <a class="rest-btn long-rest" title="Renewal"><i class="fas fa-bed"></i> Long</a>
                </div>
            </div>
            
            {{#if (eq actor.type "character")}}
            <div class="resource-row">
                <input type="text" name="system.promise" value="{{systemData.promise}}" placeholder="{{localize 'NAREQUENTA.TabPromise'}}" style="font-style: italic; width: 100%;">
            </div>
            {{/if}}
        </div>
    </header>

    <nav class="sheet-tabs tabs" data-group="primary">
        <a class="item" data-tab="essences">{{localize "NAREQUENTA.TabEssences"}}</a>
        <a class="item" data-tab="items">{{localize "NAREQUENTA.TabAbilities"}}</a>
        <a class="item" data-tab="biography">{{localize "NAREQUENTA.TabBiography"}}</a>
    </nav>

    <section class="sheet-body">

        {{!-- 1. ESSENCES TAB & COMBAT CALCULATOR --}}
        <div class="tab essences" data-group="primary" data-tab="essences">
            
            {{!-- A. Essence Grid --}}
            <div class="essence-grid-container">
                <div class="essence-header">
                    <span>{{localize "NAREQUENTA.TabEssences"}}</span>
                    <span>E_MAX</span>
                    <span>E_CUR</span>
                    <span>TIER</span>
                    <span>DICE</span>
                </div>
                {{#each systemData.essences as |essence key|}}
                <div class="essence-row">
                    <span class="essence-label">{{essence.label}}</span>
                    <input class="input-emax" type="number" name="system.essences.{{key}}.max" value="{{essence.max}}" min="50" max="100">
                    <input class="input-ecur" type="number" name="system.essences.{{key}}.value" value="{{essence.value}}" min="0" max="100">
                    <span class="derived-stat">{{essence.tier}}</span>
                    <span class="derived-stat">{{essence.diceString}}</span>
                </div>
                {{/each}}
            </div>

            {{!-- B. Combat Calculator Panel --}}
            <div class="essence-grid-container" style="background: #f0f0f0; border: 1px solid #999; padding: 0;">
                
                {{!-- Context Header --}}
                <div style="display: grid; grid-template-columns: 1fr 1fr; background: #333; color: white; padding: 5px; font-size: 0.9em; align-items: center;">
                    <div style="border-right: 1px solid #666; padding-right: 5px;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="font-weight: bold; color: #ccc;">WEAPON / ACTION:</span>
                            {{!-- Badge showing active motor essence --}}
                            {{#if systemData.calculator.active_motor}}
                            <span style="font-size: 0.8em; background: #555; color: #fff; padding: 1px 4px; border-radius: 3px; text-transform: uppercase;">
                                {{systemData.calculator.active_motor}}
                            </span>
                            {{/if}}
                        </div>
                        <select class="active-item-select" name="system.calculator.selected_item_id" style="width: 100%; font-size: 0.9em; background: #444; color: white; border: none;">
                            <option value="">-- Select Item --</option>
                            {{#each combatItems}}
                                <option value="{{this.id}}" {{#if (eq this.id ../systemData.calculator.selected_item_id)}}selected{{/if}}>
                                    {{this.name}} ({{this.range}}ft)
                                </option>
                            {{/each}}
                        </select>
                    </div>
                    
                    <div style="padding-left: 5px; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <span style="font-weight: bold; color: #ccc;">TARGET DEF:</span><br>
                            {{!-- Shows which essence the target defends with --}}
                            {{#if systemData.calculator.target_def_stat}}
                                <span style="text-transform: uppercase;">{{systemData.calculator.target_def_stat}}</span>
                            {{else}}
                                <em style="color:#999">VITALIS</em>
                            {{/if}}
                        </div>
                        <button class="launch-contest" title="Select Targets" style="background: #555; border: 1px solid #777; color: white; padding: 2px 8px; cursor: pointer;">
                            <i class="fas fa-crosshairs"></i>
                        </button>
                    </div>
                </div>

                {{!-- Input Grid --}}
                <div style="display: grid; grid-template-columns: 1fr 1px 1fr; gap: 5px; padding: 10px; align-items: center;">
                    
                    {{!-- Attacker Side --}}
                    <div style="text-align: center;">
                        <label style="font-weight: bold; display: block; font-size: 0.8em; margin-bottom: 2px;">ATTACK (d100)</label>
                        <div style="display: flex; justify-content: center; gap: 2px;">
                            <input type="number" name="system.calculator.attack_roll" value="{{systemData.calculator.attack_roll}}" placeholder="Roll" style="width: 50px; text-align: center;">
                            <a class="roll-calc-btn" data-target="system.calculator.attack_roll" data-type="d100"><i class="fas fa-dice-d20"></i></a>
                        </div>
                        
                        {{!-- Manual Proficiency Input --}}
                        <div style="margin-top: 5px;">
                            <label style="font-size: 0.8em; display:block;">Proficiency</label>
                            <div style="display: flex; justify-content: center; gap: 2px;">
                                <input type="number" name="system.calculator.prof_roll" value="{{systemData.calculator.prof_roll}}" placeholder="Prof" style="width: 50px; text-align: center;">
                                <a class="roll-calc-btn" data-target="system.calculator.prof_roll" data-type="prof"><i class="fas fa-dice-d6"></i></a>
                            </div>
                        </div>
                    </div>

                    <div style="background: #ccc; height: 100%;"></div>

                    {{!-- Defender Side --}}
                    <div style="text-align: center;">
                        <label style="font-weight: bold; display: block; font-size: 0.8em; margin-bottom: 2px;">DEFENSE (d100)</label>
                        <div style="display: flex; justify-content: center; gap: 2px;">
                            <input type="number" name="system.calculator.defense_roll" value="{{systemData.calculator.defense_roll}}" placeholder="Auto" style="width: 50px; text-align: center; border: 1px dashed #666;">
                            <a class="roll-calc-btn" data-target="system.calculator.defense_roll" data-type="d100"><i class="fas fa-dice-d20"></i></a>
                        </div>
                        <p style="font-size: 0.7em; color: #555; margin-top: 2px;">
                            (Leave 0 for Auto-Roll)
                        </p>
                    </div>
                </div>

                {{!-- Action Bar (Disabled if no attack roll) --}}
                <div style="background: #ddd; padding: 5px; text-align: center; border-top: 1px solid #ccc;">
                    <button type="button" class="roll-calculation" 
                        {{#unless systemData.calculator.attack_roll}}disabled style="opacity: 0.5; cursor: not-allowed; background: #555; color: #ccc; border: 1px solid #000; width: 90%;"{{/unless}}
                        {{#if systemData.calculator.attack_roll}}style="background: #222; color: white; border: 1px solid #000; width: 90%;"{{/if}}>
                        <i class="fas fa-calculator"></i> PREVIEW RESULT
                    </button>
                </div>

                {{!-- Output --}}
                {{#if systemData.calculator.output}}
                <div style="padding: 10px; background: #fff;">
                    {{{systemData.calculator.output}}}
                    {{#if systemData.calculator.batch_data}}
                    <button type="button" class="execute-batch" style="background: #8b0000; color: white; width: 100%; margin-top: 5px; font-weight: bold;">
                        <i class="fas fa-skull"></i> EXECUTE
                    </button>
                    {{/if}}
                </div>
                {{/if}}
            </div>

            {{!-- C. Waning Phase (PC Only) --}}
            {{#if (eq actor.type "character")}}
            <div style="text-align:center; margin-bottom: 15px; margin-top: 20px; border-top: 2px solid #333; padding-top: 10px;">
                <div style="margin-bottom: 5px;">
                    <input type="checkbox" class="waning-toggle" id="enable-waning">
                    <label for="enable-waning" style="font-weight:bold; color:#555;">Enable Waning Phase</label>
                </div>
                <button class="waning-roll-btn" style="background: #8b0000; color: white; border: 1px solid #333; display: none;">
                    <i class="fas fa-skull"></i> Trigger Waning Phase
                </button>
            </div>
            {{/if}}

            {{> "systems/narequenta/templates/parts/sheet-groups.html"}}
        </div>

        {{!-- 2. ITEMS TAB --}}
        <div class="tab items" data-group="primary" data-tab="items">
            <ol class="items-list">
                <li class="item flexrow item-header">
                    <div class="item-image"></div>
                    <div class="item-name">{{localize "NAREQUENTA.ItemNew"}}</div>
                    {{!-- Quantity Column --}}
                    <div style="flex: 0 0 40px; text-align: center; font-weight: bold; font-size: 0.8em; color: #555;">Qty</div>
                    <div class="item-controls">
                        <a class="item-control item-create" title="Create item" data-type="item" data-action="create"><i class="fas fa-plus"></i> {{localize "NAREQUENTA.Create"}}</a>
                    </div>
                </li>
                {{#each items as |item id|}}
                <li class="item flexrow" data-item-id="{{item._id}}">
                    <div class="item-image"><img src="{{item.img}}" title="{{item.name}}" width="24" height="24"/></div>
                    <h4 class="item-name mb-0">
                        <a class="rollable" data-roll-type="item"><i class="fas fa-dice-d20"></i> {{item.name}}</a>
                    </h4>
                    {{!-- Quantity Display --}}
                    <div style="flex: 0 0 40px; text-align: center; color: #555;">
                        {{#if item.system.quantity}} x{{item.system.quantity}} {{/if}}
                    </div>
                    <div class="item-controls">
                        {{!-- Use Button (Flask Icon) --}}
                        <a class="item-control item-use" title="Use/Consume"><i class="fas fa-flask"></i></a>
                        <a class="item-control" data-action="edit" title="Edit Item"><i class="fas fa-edit"></i></a>
                        <a class="item-control" data-action="delete" title="Delete Item"><i class="fas fa-trash"></i></a>
                    </div>
                </li>
                {{/each}}
            </ol>
        </div>

        {{!-- 3. BIOGRAPHY TAB --}}
        <div class="tab biography" data-group="primary" data-tab="biography">
            {{editor biographyHTML target="system.biography" button=true editable=editable engine="prosemirror"}}
        </div>

    </section>
</form>

###############################################################################
##                                                                          ###
##                              actor-sheet.js                              ###
##                                                                          ###
###############################################################################

import { EntitySheetHelper } from "./helper.js";
import { ATTRIBUTE_TYPES } from "./constants.js";

export class NarequentaActorSheet extends ActorSheet {

  /** @inheritdoc */
  static get defaultOptions() {
    return foundry.utils.mergeObject(super.defaultOptions, {
      classes: ["narequenta", "sheet", "actor"],
      template: "systems/narequenta/templates/actor-sheet.html",
      width: 720,
      height: 1125,
      tabs: [{navSelector: ".sheet-tabs", contentSelector: ".sheet-body", initial: "essences"}]
    });
  }

  /** @inheritdoc */
  async getData(options) {
    const context = await super.getData(options);
    const actorData = this.actor.toObject(false);
    context.systemData = this.actor.system; 
    context.system = this.actor.system; 
    EntitySheetHelper.getAttributeData(actorData);
    context.shorthand = !!game.settings.get("narequenta", "macroShorthand");
    context.dtypes = ATTRIBUTE_TYPES;
    context.biographyHTML = await TextEditor.enrichHTML(context.systemData.biography, {
      secrets: this.document.isOwner,
      async: true
    });

    // Combat Items Dropdown (Range = 5ft Default)
    context.combatItems = this.actor.items.filter(i => ["weapon", "ability"].includes(i.type))
        .map(i => ({
            id: i.id,
            name: i.name,
            range: i.system.range || 5, // 5ft Default
            type: i.type.toUpperCase()
        }));

    return context;
  }

  /** @inheritdoc */
  activateListeners(html) {
    super.activateListeners(html);
    if ( !this.isEditable ) return;

    // Standard Listeners
    html.find(".item-control").click(this._onItemControl.bind(this));
    html.find(".items .rollable").on("click", this._onItemRoll.bind(this));
    html.find(".item-use").click(this._onItemUse.bind(this)); // Consumables
    
    // Calculator Listeners
    html.find(".roll-calculation").click(this._onCalculate.bind(this));
    html.find(".execute-batch").click(this._onExecuteBatch.bind(this));
    html.find(".active-item-select").change(this._onSelectActiveItem.bind(this));

    // Targeting & Dice
    html.find(".launch-contest").click(this._onLaunchContest.bind(this));
    html.find(".roll-calc-btn").click(this._onRollSheetCalc.bind(this));    

    // Phase & Rest & Combat
    html.find(".waning-toggle").change(ev => {
        const isChecked = ev.target.checked;
        if (isChecked) html.find(".waning-roll-btn").slideDown();
        else html.find(".waning-roll-btn").slideUp();
    });
    html.find(".waning-roll-btn").click(this._onWaningPhase.bind(this));
    html.find(".short-rest").click(this._onShortRest.bind(this));
    html.find(".long-rest").click(this._onLongRest.bind(this));
    html.find(".use-action-surge").click(this._onUseActionSurge.bind(this));
    html.find(".end-turn").click(this._onEndTurn.bind(this));
  }

  /* -------------------------------------------- */
  /* ITEM SELECTION (Setup Calculator)            */
  /* -------------------------------------------- */
  async _onSelectActiveItem(event) {
      event.preventDefault();
      const itemId = event.target.value;
      const item = this.actor.items.get(itemId);
      if (!item) return;

      const sys = item.system;
      const motorKey = sys.cost?.motor || "vitalis";
      const motorVal = this.actor.system.essences[motorKey]?.value || 0;
      const weight = (typeof sys.weight !== "undefined") ? Number(sys.weight) : 15; 
      const range = Number(sys.range) || 5;
      
      // [NEW] Determine Damage Destination (default HP)
      const damageTarget = sys.target_resource || "hp";

      // Evaluate Damage/Healing Formula
      let bonusVal = 0;
      const bonusRaw = sys.damage_bonus || "0";
      try {
          const r = new Roll(bonusRaw.toString());
          await r.evaluate();
          bonusVal = r.total;
      } catch (e) {
          console.error("Invalid Formula", e);
          bonusVal = 0;
      }

      await this.actor.update({
          "system.calculator.selected_item_id": itemId,
          "system.calculator.item_name": item.name,
          "system.calculator.item_weight": weight,
          "system.calculator.item_bonus": bonusVal,
          "system.calculator.active_motor": motorKey,
          "system.calculator.active_motor_val": motorVal,
          "system.calculator.target_def_stat": motorKey, // Defense Roll (Same Essence)
          "system.calculator.apply_to": damageTarget,    // [NEW] Damage Destination
          "system.calculator.item_range": range,
          "system.calculator.output": "" 
      });

      ui.notifications.info(`Active: ${item.name} (${range}ft). Motor: ${motorKey.toUpperCase()}. Dmg: ${damageTarget.toUpperCase()}`);
  }

  /* -------------------------------------------- */
  /* COMBAT CALCULATOR v0.9.62                    */
  /* -------------------------------------------- */
  async _onCalculate(event) {
      event.preventDefault();
      const calc = this.actor.system.calculator;
      const targetIds = calc.target_ids || [];
      
      // Safety Checks
      const rawAttack = calc.attack_roll;
      if (!rawAttack && rawAttack !== 0) { ui.notifications.warn("Please roll Attack (d100)."); return; }
      if (Number(rawAttack) === 0) { ui.notifications.warn("Attack cannot be 0."); return; }
      if (!Array.isArray(targetIds) || targetIds.length === 0) { ui.notifications.warn("No targets selected."); return; }

      // Inputs
      const Attacker_d100 = Number(calc.attack_roll);
      const R_prof = Number(calc.prof_roll) || 0;
      const Manual_Def = Number(calc.defense_roll) || 0;
      const itemBonus = Number(calc.item_bonus) || 0;
      const itemWeight = (typeof calc.item_weight !== "undefined") ? Number(calc.item_weight) : 15; 
      
      const motorKey = calc.active_motor || "vitalis"; 
      const E_max = this.actor.system.essences[motorKey]?.max || 100;
      const E_cur = this.actor.system.essences[motorKey]?.value || 100;
      const defStat = calc.target_def_stat || "vitalis";
      const targetResource = calc.apply_to || "hp";

      let Attacker_Tier = (this.actor.type === 'character') ? (this.actor.system.resources.action_surges.max || 0) : (this.actor.system.tier || 0);

      // Determine Mode
      const isHealing = itemBonus < 0; 
      const isPotion = isHealing && (itemWeight === 0);

      // Hit Check (Zone Logic)
      const effectiveRoll = Attacker_d100 - R_prof;
      let zonePenalty = 0;
      if (E_cur <= 25) zonePenalty = 30;
      else if (E_cur <= 50) zonePenalty = 20;
      else if (E_cur <= 75) zonePenalty = 10;

      const successThreshold = E_max - zonePenalty;
      let attackerSuccess = true;
      let hitLabel = "SUCCESS";

      if (Attacker_d100 >= 96) { attackerSuccess = false; hitLabel = "CRIT FAIL"; }
      else if (Attacker_d100 <= 5) { attackerSuccess = true; hitLabel = "CRIT SUCCESS"; }
      else if (effectiveRoll > successThreshold) { attackerSuccess = false; hitLabel = "MISS"; }

      // HTML Output Builders
      let sheetListHtml = `<div style="font-size:0.85em; color:#555; margin-bottom:5px; border-bottom:1px solid #ccc;">
          Attack: <strong>${effectiveRoll}</strong> vs <strong>${successThreshold}</strong> (${hitLabel})
      </div>`;
      
      let chatTableRows = ""; // For Chat Log
      let payloadTargets = []; 

      for (const tid of targetIds) {
          const tToken = canvas.tokens.get(tid);
          if (!tToken) continue;
          
          const tActor = tToken.actor;
          const Def_Ecur = tActor.system.essences[defStat]?.value || 50;
          const Def_Tier = (tActor.type==='character') ? (tActor.system.resources.action_surges.max||0) : (tActor.system.tier||0);
          
          let Def_Roll = (targetIds.length === 1 && Manual_Def > 0) ? Manual_Def : Math.floor(Math.random() * 100) + 1;
          const D_Margin = Def_Roll - Def_Ecur; 
          
          let finalDamage = 0;
          let details = "";
          let resultColor = "#333";
          
          if (attackerSuccess) {
              if (isHealing) {
                  let healAmount = Math.abs(itemBonus);
                  if (!isPotion) healAmount += R_prof;
                  finalDamage = -Math.max(1, healAmount);
                  resultColor = "#006400"; // Green
              } else {
                  let A_FP = 100 - effectiveRoll;
                  if (Attacker_d100 <= 5) A_FP = 100 - (1 - R_prof);
                  const M_Defense = Def_Tier * 5.5;
                  let rawCalc = (A_FP - M_Defense + D_Margin + R_prof + itemBonus);
                  let baseDamage = Math.max(R_prof, rawCalc); 
                  if (baseDamage < 1) baseDamage = 1;

                  let mult = 1.0;
                  const diff = Attacker_Tier - Def_Tier;
                  if (diff >= 1) mult = 1.25; if (diff >= 2) mult = 1.50;
                  if (diff === 0) mult = 1.00; if (diff === -1) mult = 0.75; if (diff <= -2) mult = 0.50;

                  finalDamage = Math.max(1, Math.floor(baseDamage * mult));
                  resultColor = "#8b0000"; // Red
              }
              
              payloadTargets.push({ id: tid, damage: finalDamage, name: tToken.name });
              details = `(Def:${Def_Roll})`;
              
              // Add Row to Chat
              chatTableRows += `<tr>
                  <td style="text-align:left;">${tToken.name}</td>
                  <td style="text-align:center;">${Def_Roll}</td>
                  <td style="text-align:right; font-weight:bold; color:${resultColor};">${finalDamage > 0 ? finalDamage : '+' + Math.abs(finalDamage)}</td>
              </tr>`;

          } else {
              details = `(Missed)`;
              chatTableRows += `<tr><td style="text-align:left; color:#999;">${tToken.name}</td><td colspan="2" style="text-align:center; color:#999;">Evaded</td></tr>`;
          }

          sheetListHtml += `
          <div style="display:flex; justify-content:space-between; align-items:center; padding:2px 0;">
              <div><strong>${tToken.name}</strong> <span style="font-size:0.8em; color:#555;">${details}</span></div>
              <div style="font-weight:bold; color:${resultColor}; font-size:1.1em;">
                  ${finalDamage > 0 ? finalDamage : '+' + Math.abs(finalDamage)}
              </div>
          </div>`;
      }

      // Attrition
      let attritionCost = Math.max(0, itemWeight - Math.floor(R_prof / 2));
      if (Attacker_d100 <= 5) attritionCost = Math.floor(attritionCost / 2);
      if (Attacker_d100 >= 96) attritionCost = attritionCost * 2;

      sheetListHtml += `<div style="text-align:right; margin-top:5px; font-size:0.8em; color:#333; font-weight:bold;">Self Attrition: -${attritionCost}%</div>`;

      const resolutionPayload = { essenceKey: motorKey, attritionCost: attritionCost, targets: payloadTargets, targetResource: targetResource };
      
      await this.actor.update({
          "system.calculator.output": sheetListHtml,
          "system.calculator.batch_data": JSON.stringify(resolutionPayload) 
      });
      
      // Detailed Chat Output
      ChatMessage.create({ 
          speaker: ChatMessage.getSpeaker({ actor: this.actor }), 
          content: `
          <div class="narequenta chat-card">
              <h3>${isHealing ? "Restoration" : "Attack Resolution"}</h3>
              <div><strong>Status:</strong> ${hitLabel}</div>
              <div style="font-size:0.9em;">Cost: -${attritionCost}% ${motorKey.toUpperCase()}</div>
              <hr>
              <table style="width:100%; font-size:0.9em; border-collapse:collapse;">
                  <thead><tr style="background:#eee;"><th style="text-align:left;">Target</th><th>Def</th><th>Effect</th></tr></thead>
                  <tbody>${chatTableRows}</tbody>
              </table>
              <div style="margin-top:5px; font-style:italic; font-size:0.8em; text-align:center;">
                  Apply results via Sheet.
              </div>
          </div>` 
      });
  }

  /* -------------------------------------------- */
  /* TARGETING DIALOG (Auto-Select AoE)           */
  /* -------------------------------------------- */
  _onLaunchContest(event) {
      if(event) event.preventDefault();
      const attacker = this.actor;
      const calc = attacker.system.calculator;
      const range = calc.item_range || 5;
      
      // Determine Target Type from the Item itself if possible
      const itemId = calc.selected_item_id;
      const item = attacker.items.get(itemId);
      const targetType = item?.system.target_type || "one"; // one, aoe, self
      
      const defaultDef = calc.active_motor || "vitalis";
      const isHealing = (Number(calc.item_bonus) || 0) < 0;
      const tier = (attacker.type === 'character') ? (attacker.system.resources.action_surges.max || 0) : (attacker.system.tier || 0);

      const tokens = attacker.getActiveTokens();
      if (tokens.length === 0) { ui.notifications.warn("Place token on scene."); return; }
      
      let pcHtml = ""; let npcHtml = ""; let count = 0;
      canvas.tokens.placeables.forEach(t => {
          if (t.id === tokens[0].id) return; 
          const dist = canvas.grid.measureDistance(tokens[0], t);
          if (dist <= range && t.actor?.system.resources?.hp?.value > 0) {
              const entry = `<div style="padding:2px;"><input type="checkbox" name="target" value="${t.id}" class="target-checkbox" data-type="${t.actor.type}"> <strong>${t.name}</strong> (${Math.round(dist)}ft)</div>`;
              if (t.actor.type === "character") pcHtml += entry; else npcHtml += entry;
              count++;
          }
      });

      if (count === 0) { ui.notifications.warn(`No targets within ${range}ft.`); return; }

      // Selection Logic: If AoE, check by default based on Tier/Type
      let autoSelectScript = "";
      
      if (targetType === "aoe") {
          // If it's AOE, we default to selecting things immediately
          if (isHealing) {
              autoSelectScript = `$('input[data-type="character"]').prop('checked', true);`;
          } else {
              if (tier >= 3) autoSelectScript = `$('input[data-type="npc"]').prop('checked', true);`; // Mastery
              else autoSelectScript = `$('input.target-checkbox').prop('checked', true);`; // Wild
          }
      } else {
          // Single Target defaults to nothing checked
          autoSelectScript = "";
      }

      const essences = ["vitalis", "motus", "sensus", "verbum", "anima", "hp"];
      let options = "";
      essences.forEach(k => { options += `<option value="${k}" ${k===defaultDef?"selected":""}>${k.toUpperCase()}</option>`; });

      const content = `
      <form>
          <div style="text-align:center; margin-bottom:5px;">Range: <strong>${range}ft</strong></div>
          <div style="display:flex; gap:5px; margin-bottom:10px;">
              <div style="flex:1; background:#eef; padding:5px; border:1px solid #ccc;"><strong>Allies</strong><br>${pcHtml || "-"}</div>
              <div style="flex:1; background:#fee; padding:5px; border:1px solid #ccc;"><strong>Enemies</strong><br>${npcHtml || "-"}</div>
          </div>
          <div style="text-align:center; margin-bottom:10px;">
              <button type="button" id="auto-select-btn" style="font-size:0.8em; width:100%;">
                  ${targetType === "aoe" ? "Reset / Auto-Select" : "Auto-Select Targets"}
              </button>
          </div>
          <label>Defensive Stat:</label>
          <select id="target-essence" style="width:100%;">${options}</select>
      </form>
      <script>
          // Run immediately if AoE to show selection
          ${autoSelectScript}
          
          $("#auto-select-btn").click(function() { 
              // Toggle logic if button is clicked manually
              const anyChecked = $("input:checkbox:checked").length > 0;
              if (anyChecked) {
                  $("input:checkbox").prop('checked', false); 
              } else {
                  ${autoSelectScript || `$('input.target-checkbox').prop('checked', true);`} 
              }
          });
      </script>`;

      new Dialog({ title: `Targeting (${targetType.toUpperCase()})`, content: content, buttons: { confirm: { label: "Lock", callback: async (html) => {
          const ids = []; html.find("input:checked").each(function(){ ids.push($(this).val()); });
          if(ids.length) await attacker.update({ "system.calculator.target_ids": ids, "system.calculator.target_def_stat": html.find("#target-essence").val(), "system.calculator.target_name": `${ids.length} Targets` });
      }}}}).render(true);
  }

  /* -------------------------------------------- */
  /* EXECUTE BATCH (Apply Damage/Heal)            */
  /* -------------------------------------------- */
  async _onExecuteBatch(event) {
      event.preventDefault();
      const rawData = this.actor.system.calculator.batch_data;
      if (!rawData) return;

      // [NEW] Read targetResource from payload
      const { essenceKey, attritionCost, targets, targetResource } = JSON.parse(rawData);
      
      // Default to HP if missing (legacy safety)
      const applyTo = targetResource || "hp";

      // 1. Attrition
      const currentVal = this.actor.system.essences[essenceKey].value;
      const newVal = Math.max(0, currentVal - attritionCost);
      await this.actor.update({ [`system.essences.${essenceKey}.value`]: newVal });

      // 2. Damage / Healing
      if (targets && targets.length > 0) {
          for (const tData of targets) {
              const token = canvas.tokens.get(tData.id);
              if (token && token.actor) {
                  let currentVal = 0;
                  let maxVal = 100;
                  let updatePath = "";

                  if (applyTo === "hp") {
                      currentVal = token.actor.system.resources.hp.value;
                      maxVal = token.actor.system.resources.hp.max;
                      updatePath = "system.resources.hp.value";
                  } else {
                      // Apply to Essence
                      currentVal = token.actor.system.essences[applyTo]?.value || 0;
                      maxVal = token.actor.system.essences[applyTo]?.max || 100;
                      updatePath = `system.essences.${applyTo}.value`;
                  }

                  let finalVal = currentVal - tData.damage;
                  if (finalVal < 0) finalVal = 0;
                  if (finalVal > maxVal) finalVal = maxVal;

                  await token.actor.update({ [updatePath]: finalVal });
                  
                  // Check Death (Only for HP)
                  if (applyTo === "hp" && finalVal <= 0 && tData.damage > 0) {
                       const isDead = token.actor.effects.some(e => e.statusId === "dead" || (e.statuses && e.statuses.has("dead")));
                       if (!isDead) await token.actor.toggleStatusEffect("dead", { overlay: true });
                  }
              }
          }
      }

      await this.actor.update({
          "system.calculator.attack_roll": 0,
          "system.calculator.prof_roll": 0,
          "system.calculator.defense_roll": 0,
          "system.calculator.batch_data": "",
          "system.calculator.output": `Applied. -${attritionCost}% Attrition.`
      });
      ui.notifications.info("Resolution Complete.");
  }

  /* -------------------------------------------- */
  /* COMBAT UTILITIES                             */
  /* -------------------------------------------- */
  async _onEndTurn(event) {
      event.preventDefault();
      const combat = game.combat;
      if (!combat) return;
      
      // Advance
      await combat.nextTurn();
      
      // Open Next Sheet
      if (combat.combatant?.actor) combat.combatant.actor.sheet.render(true);
      
      // [FIX] Close Current Sheet
      this.close();
  }

  /* -------------------------------------------- */
  /* CONSUMABLES LOGIC v0.9.60                   */
  /* -------------------------------------------- */
  async _onItemUse(event) {
      event.preventDefault();
      const li = $(event.currentTarget).parents(".item");
      const item = this.actor.items.get(li.data("itemId"));
      if (!item) return;

      const sys = item.system;
      const qty = sys.quantity || 0;
      const type = sys.target_type || "one"; 
      
      // [NEW] Get the specific resource this item affects (default hp)
      const resourceKey = sys.target_resource || "hp"; 

      if (qty <= 0) { ui.notifications.warn("Item Depleted."); return; }

      // Helper to execute the roll/heal
      const executeConsume = async (targetActor) => {
          await item.update({ "system.quantity": qty - 1 });
          const formula = sys.damage_bonus || "0";
          
          try {
              const r = new Roll(formula);
              await r.evaluate();
              if (game.dice3d) game.dice3d.showForRoll(r);
              
              // 1. Determine Paths based on Resource Key
              let currentPath, maxPath, label;
              let currentVal, maxVal;

              if (resourceKey === "hp") {
                  currentPath = "system.resources.hp.value";
                  maxPath = "system.resources.hp.max";
                  currentVal = targetActor.system.resources.hp.value;
                  maxVal = targetActor.system.resources.hp.max;
                  label = "HP";
              } else {
                  // It's an Essence (vitalis, motus, etc.)
                  currentPath = `system.essences.${resourceKey}.value`;
                  maxPath = `system.essences.${resourceKey}.max`;
                  currentVal = targetActor.system.essences[resourceKey]?.value || 0;
                  maxVal = targetActor.system.essences[resourceKey]?.max || 100;
                  label = resourceKey.toUpperCase();
              }

              // 2. Apply Effect
              // Negative Total = Healing (Add to pool)
              // Positive Total = Damage (Subtract from pool)
              let change = 0;
              let newVal = 0;

              if (r.total < 0) {
                  // HEALING
                  change = Math.abs(r.total);
                  newVal = Math.min(maxVal, currentVal + change);
                  ui.notifications.info(`${targetActor.name}: Recovered ${change} ${label}.`);
              } else {
                  // DAMAGE / REDUCTION
                  change = r.total;
                  newVal = Math.max(0, currentVal - change);
                  ui.notifications.info(`${targetActor.name}: Lost ${change} ${label}.`);
              }

              // 3. Update Actor
              await targetActor.update({ [currentPath]: newVal });

              r.toMessage({ 
                  speaker: ChatMessage.getSpeaker({ actor: this.actor }), 
                  flavor: `Consumed: ${item.name} (${label} ${r.total < 0 ? "+" : "-"}${change})` 
              });

          } catch (e) { console.error(e); }
      };

      // Target selection logic (Self vs Other)
      if (type === "self") {
          executeConsume(this.actor);
      } else {
          new Dialog({
              title: `Use ${item.name}`,
              content: `<p>Target: <strong>${resourceKey.toUpperCase()}</strong></p>`,
              buttons: {
                  self: {
                      label: "Self",
                      icon: "<i class='fas fa-user'></i>",
                      callback: () => executeConsume(this.actor)
                  },
                  target: {
                      label: "Target",
                      icon: "<i class='fas fa-bullseye'></i>",
                      callback: () => {
                          const targets = Array.from(game.user.targets);
                          if (targets.length !== 1) {
                              ui.notifications.warn("Select exactly 1 target.");
                              return;
                          }
                          executeConsume(targets[0].actor);
                      }
                  }
              },
              default: "self"
          }).render(true);
      }
  }

  /* -------------------------------------------- */
  /* REST, RESOURCES, TARGETING, LEGACY           */
  /* -------------------------------------------- */
  
  async _onLongRest(event) {
    event.preventDefault();
    const confirmed = await Dialog.confirm({
      title: "Renewal (Long Rest)",
      content: "<p>Restores <strong>HP</strong> and <strong>Essences (Current)</strong> to <strong>100%</strong>.</p>"
    });
    if (confirmed) {
      const updates = {};
      const essences = this.actor.system.essences;
      for (const [key, essence] of Object.entries(essences)) { updates[`system.essences.${key}.value`] = 100; }
      if (this.actor.type === "character") updates[`system.resources.action_surges.value`] = this.actor.system.resources.action_surges.max;
      updates[`system.resources.hp.value`] = this.actor.system.resources.hp.max;
      updates[`system.calculator.target_ids`] = [];
      updates[`system.calculator.target_name`] = "None";
      updates[`system.calculator.batch_data`] = "";
      updates[`system.calculator.output`] = "Rest Complete.";
      await this.actor.update(updates);
      ChatMessage.create({ speaker: ChatMessage.getSpeaker({ actor: this.actor }), content: `<div class="narequenta chat-card"><h3>Renewal</h3><p>Restored to 100%.</p></div>` });
    }
  }

/* -------------------------------------------- */
  /* REST & RECOVERY (v0.9.64 Corrected)          */
  /* -------------------------------------------- */

  async _onShortRest(event) {
    event.preventDefault();
    
    // 1. Determine Proficiency Tier (D_prof)
    // Characters use Action Surge Max as proxy for Tier, NPCs use explicit Tier.
    const isChar = this.actor.type === "character";
    const tier = isChar ? (this.actor.system.resources.action_surges.max || 0) : (this.actor.system.tier || 0);
    
    // v0.9.64 Rule: Roll D_prof. 
    // If Tier 0 (No proficiency), fallback to base 1d10 (instead of old 1d6).
    const diceCount = Math.max(1, tier);
    const formula = `${diceCount}d10`;

    const content = `
    <div class="narequenta">
        <div class="form-group">
            <label><strong>Recovery Type:</strong></label>
            <select id="rest-mode" style="width:100%; margin-bottom: 10px;">
              <option value="quick" selected>Quick Breath (Combat Action)</option>
              <option value="short">Short Rest (Respite)</option>
            </select>
        </div>
        <div style="background:#f0f0f0; padding:8px; border-radius:4px; font-size:0.9em;">
            <div><strong>Proficiency Tier:</strong> ${tier}</div>
            <div><strong>Recovery Formula:</strong> ${formula}</div>
        </div>
        <p style="font-size:0.8em; margin-top:5px; color:#555;">Restores Active Vigor ($E_{cur}$) to all Essences.</p>
    </div>`;

    new Dialog({
      title: "Recovery Roll",
      content: content,
      buttons: {
        roll: {
          icon: '<i class="fas fa-dice-d20"></i>',
          label: "Roll Recovery",
          callback: async (html) => {
            const mode = html.find("#rest-mode").val();

            // 2. Evaluate Roll
            const rollObj = new Roll(formula);
            await rollObj.evaluate();
            if (game.dice3d) game.dice3d.showForRoll(rollObj);
            
            const finalRecovery = rollObj.total;

            // 3. Update Actor
            const updates = {};
            
            // Recover Essences (Cap at 100%)
            for (const [key, essence] of Object.entries(this.actor.system.essences)) {
                if (essence.value < 100) {
                    updates[`system.essences.${key}.value`] = Math.min(100, essence.value + finalRecovery);
                }
            }

            // Recover HP (Consistent with rest logic)
            const hp = this.actor.system.resources.hp;
            if (hp.value < hp.max) {
                updates[`system.resources.hp.value`] = Math.min(hp.max, hp.value + finalRecovery);
            }

            await this.actor.update(updates);

            // 4. Generate Chat Output
            const isQuick = (mode === "quick");
            const title = isQuick ? "Quick Breath" : "Short Rest";
            const color = isQuick ? "#8b0000" : "#2e8b57"; // Red for Combat, Green for Safe
            
            let flavor = `<h3 style="color:${color}; border-bottom:1px solid ${color}">${title}</h3>`;
            
            if (isQuick) {
                flavor += `<div style="font-weight:bold; color:#a00; font-size:0.85em; margin-bottom:5px;">⚠️ COST: ENTIRE TURN</div>`;
            }

            flavor += `
            <div style="text-align:center; padding:5px;">
                <span style="font-size:1.4em; font-weight:bold;">+${finalRecovery}%</span><br>
                <span style="font-size:0.8em; color:#666;">Active Vigor Restored</span>
            </div>
            <div style="text-align:center; font-size:0.8em; color:#999; margin-top:5px;">Formula: ${formula}</div>`;

            ChatMessage.create({ 
                speaker: ChatMessage.getSpeaker({ actor: this.actor }), 
                content: `<div class="narequenta chat-card">${flavor}</div>` 
            });
          }
        }
      }
    }).render(true);
  }

  async _onUseActionSurge(event) {
      event.preventDefault();
      const current = this.actor.system.resources.action_surges.value;
      if (current > 0) {
          await this.actor.update({"system.resources.action_surges.value": current - 1});
          ChatMessage.create({ speaker: ChatMessage.getSpeaker({ actor: this.actor }), content: `<div class="narequenta chat-card"><h3 style="color:#d4af37">Action Surge!</h3><p>Remaining: ${current - 1}</p></div>` });
      } else { ui.notifications.warn("No Action Surges left."); }
  }

  async _onEndTurn(event) {
      event.preventDefault();
      const combat = game.combat;
      if (!combat) return;
      await combat.nextTurn();
      if (combat.combatant?.actor) combat.combatant.actor.sheet.render(true);
  }

  /* -------------------------------------------- */
  /* TACTICAL TARGETING UI (AoE Logic)            */
  /* -------------------------------------------- */
  _onLaunchContest(event) {
      if(event) event.preventDefault();
      
      // 1. Setup Data
      const attacker = this.actor;
      const calc = attacker.system.calculator;
      const range = calc.item_range || 5;
      const defaultDef = calc.active_motor || "vitalis";
      
      // Determine if Offensive or Healing based on bonus in calculator
      const isHealing = (Number(calc.item_bonus) || 0) < 0;
      
      // Determine Tier for Safeguard Logic
      const tier = (attacker.type === 'character') 
          ? (attacker.system.resources.action_surges.max || 0) 
          : (attacker.system.tier || 0);

      const tokens = attacker.getActiveTokens();
      if (tokens.length === 0) { ui.notifications.warn("Place token on scene."); return; }
      
      // 2. Build Target Lists
      let pcHtml = ""; let npcHtml = ""; let count = 0;
      let allIds = []; let npcIds = []; let pcIds = [];

      canvas.tokens.placeables.forEach(t => {
          if (t.id === tokens[0].id) return; 
          const dist = canvas.grid.measureDistance(tokens[0], t);
          if (dist <= range && t.actor?.system.resources?.hp?.value > 0) {
              
              const entry = `
              <div style="padding:2px;">
                  <input type="checkbox" name="target" value="${t.id}" class="target-checkbox" data-type="${t.actor.type}"> 
                  <strong>${t.name}</strong> (${Math.round(dist)}ft)
              </div>`;
              
              if (t.actor.type === "character") {
                  pcHtml += entry;
                  pcIds.push(t.id);
              } else {
                  npcHtml += entry;
                  npcIds.push(t.id);
              }
              allIds.push(t.id);
              count++;
          }
      });

      if (count === 0) { ui.notifications.warn(`No targets within ${range}ft.`); return; }

      // 3. Build Selection Logic Buttons
      let autoSelectScript = "";
      
      if (isHealing) {
          // HEALING: Auto-select PCs (Allies)
          autoSelectScript = `$('input[data-type="character"]').prop('checked', true);`;
      } else {
          // DAMAGE: Check Tier
          if (tier >= 3) {
              // Mastery: Safe Casting (Select NPCs only)
              autoSelectScript = `$('input[data-type="npc"]').prop('checked', true);`;
          } else {
              // Wild: Dangerous Casting (Select ALL)
              autoSelectScript = `$('input.target-checkbox').prop('checked', true);`;
          }
      }

      // 4. Render Dialog
      const essences = ["vitalis", "motus", "sensus", "verbum", "anima", "hp"];
      let options = "";
      essences.forEach(k => { options += `<option value="${k}" ${k===defaultDef?"selected":""}>${k.toUpperCase()}</option>`; });

      const content = `
      <form>
          <div style="text-align:center; margin-bottom:5px;">Range: <strong>${range}ft</strong></div>
          
          <div style="display:flex; gap:5px; margin-bottom:10px;">
              <div style="flex:1; background:#eef; padding:5px; border:1px solid #ccc;">
                  <strong>Allies (PCs)</strong><br>${pcHtml || "-"}
              </div>
              <div style="flex:1; background:#fee; padding:5px; border:1px solid #ccc;">
                  <strong>Enemies (NPCs)</strong><br>${npcHtml || "-"}
              </div>
          </div>

          <div style="text-align:center; margin-bottom:10px;">
              <button type="button" id="auto-select-btn" style="font-size:0.8em; width:100%;">
                  ${isHealing ? "Auto-Target Allies (Healing)" : (tier >= 3 ? "Auto-Target Enemies (Mastery)" : "⚠️ Auto-Target Area (Wild Magic)")}
              </button>
          </div>

          <label>Defensive Stat:</label>
          <select id="target-essence" style="width:100%;">${options}</select>
      </form>
      <script>
          $("#auto-select-btn").click(function() {
              $("input:checkbox").prop('checked', false); // Clear
              ${autoSelectScript} // Apply Logic
          });
      </script>
      `;

      new Dialog({ 
          title: "Tactical Targeting", 
          content: content, 
          buttons: { 
              confirm: { 
                  label: "Lock Targets", 
                  icon: "<i class='fas fa-crosshairs'></i>",
                  callback: async (html) => {
                      const ids = []; 
                      html.find("input:checked").each(function(){ ids.push($(this).val()); });
                      
                      if(ids.length) await this.actor.update({ 
                          "system.calculator.target_ids": ids, 
                          "system.calculator.target_def_stat": html.find("#target-essence").val(), 
                          "system.calculator.target_name": `${ids.length} Targets` 
                      });
                  }
              }
          }
      }).render(true);
  }

  _onItemControl(event) { /* Legacy CRUD */ 
    event.preventDefault(); const btn = event.currentTarget; const li = btn.closest(".item"); const item = this.actor.items.get(li?.dataset.itemId);
    if(btn.dataset.action === "create") return getDocumentClass("Item").create({name: game.i18n.localize("NAREQUENTA.ItemNew"), type: "item"}, {parent: this.actor});
    if(btn.dataset.action === "edit") return item.sheet.render(true);
    if(btn.dataset.action === "delete") return item.delete();
  }
  
  _onItemRoll(event) { /* Legacy click-to-load wrapper */
    event.preventDefault(); const li = $(event.currentTarget).parents(".item"); const id = li.data("itemId");
    const dropdown = this.element.find(".active-item-select");
    if(dropdown.length) dropdown.val(id).change(); else this._onSelectActiveItem({target:{value:id}, preventDefault:()=>{}});
  }

  _onRollSheetCalc(event) { /* Helper dice roller for calculator inputs */
      event.preventDefault(); const btn = $(event.currentTarget);
      const type = btn.data("type"); const target = btn.data("target");
      let formula = "1d100";
      if (type === "prof") {
          let tier = (this.actor.type === 'character') ? (this.actor.system.resources.action_surges.max||0) : (this.actor.system.tier||0);
          if(tier===0) { this.actor.update({[target]:0}); return; }
          formula = `${tier}d10`;
      }
      new Roll(formula).evaluate().then(r => { if(game.dice3d) game.dice3d.showForRoll(r); this.actor.update({[target]: r.total}); });
  }

  async _onWaningPhase(event) { /* ... Kept from previous ... */ }
  async _onApplySheetDamage(event) { /* ... Kept from previous ... */ }
}

###############################################################################
##                                                                          ###
##                                 actor.js                                 ###
##                                                                          ###
###############################################################################

import { EntitySheetHelper } from "./helper.js";

export class NarequentaActor extends Actor {

  /** @inheritdoc */
  prepareDerivedData() {
    super.prepareDerivedData();

    // Safety check to prevent crashes on actors without data
    if (!this.system.essences) return;

    // 1. Run Tier Calculation for EVERYONE (PC & NPC)
    this._prepareEssenceData();

    // 2. Legacy Worldbuilding Logic
    this.system.groups = this.system.groups || {};
    this.system.attributes = this.system.attributes || {};
    EntitySheetHelper.clampResourceValues(this.system.attributes);
  }

  _prepareEssenceData() {
      const system = this.system;
      const essences = system.essences || {};
      
      // Track highest tier found among essences
      let maxTier = 0;

      for (let [key, essence] of Object.entries(essences)) {
          // A. Enforce Hard Floor (50%)
          if (essence.max < 50) essence.max = 50;
          if (essence.max > 100) essence.max = 100;

          // B. Calculate Tier based on Remaining E_max
          let tier = 0;
          if (essence.max <= 50) tier = 5;      
          else if (essence.max <= 60) tier = 4; 
          else if (essence.max <= 70) tier = 3; 
          else if (essence.max <= 80) tier = 2;
          else if (essence.max <= 90) tier = 1; 
          else tier = 0;
          
          // C. Derive Dice Pool
          essence.tier = tier;
          essence.diceCount = (tier === 0) ? 0 : tier;
          essence.diceString = (tier > 0) ? `${tier}d10` : "0";
          essence.mitigation = (tier * 5.5); 
          
          // Update Max Tier Tracker
          if (tier > maxTier) maxTier = tier;
		  // --- v0.9.3 ZONE CALCULATION ---
		  // Calculate percentage of Current vs Max (Absolute 100 scale based on rules)
		  const eCur = essence.value; 

		  let zonePenalty = 0;
		  let zoneLabel = "Peak"; // 100% - 76%

		  if (eCur <= 25) { 
			  zoneLabel = "Hollow"; 
			  zonePenalty = -30; 
		  } else if (eCur <= 50) { 
			  zoneLabel = "Fading"; 
			  zonePenalty = -20; 
		  } else if (eCur <= 75) { 
			  zoneLabel = "Waning"; 
			  zonePenalty = -10; 
		  }

		  essence.zonePenalty = zonePenalty;
		  essence.zoneLabel = zoneLabel;
		  // This allows you to reference @essences.vitalis.zonePenalty in rolls		  
		  
      }

      // D. ASSIGN GLOBAL TIER (Fixes NPC Proficiency)
      // For Characters, this drives Action Surges.
      if (this.type === "character") {
          if (system.resources?.action_surges) {
              system.resources.action_surges.max = maxTier;
          }
      }
      
      // For NPCs (and generic actors), we must set the system.tier 
      // so the calculator can read it easily.
      system.tier = maxTier;
  }

  /** @inheritdoc */
  async rollInitiative(createCombatants=true, context={}) {
    const parts = ["1d20"];
    // Tie-breaker: Sensus Tier as decimal
    if (this.system.essences?.sensus) {
        parts.push(String(this.system.essences.sensus.tier / 10));
    }
    const formula = parts.join("+") || "1d20";

    await new Roll(formula, this.getRollData()).toMessage({
        speaker: ChatMessage.getSpeaker({actor: this}),
        flavor: `Rolling Initiative`
    });

    await super.rollInitiative(createCombatants, { ...context, formula });
  }

  /** @inheritdoc */
  getRollData() {
    const data = { ...this.system };
    if (this.system.essences) {
        for (const [key, value] of Object.entries(this.system.essences)) {
            data[key] = value;
        }
    }
    return data;
  }
}


###############################################################################
##                                                                          ###
##                               CHANGELOG.md                               ###
##                                                                          ###
###############################################################################

# CHANGELOG
## Version 0.9.0

- This is the initial version of the Nárëquenta system.
- The core description states the game is about **Beautiful Erosion**, where heroes fade and **Proficiency Compensates for Decline**.
- Defines basic actor types (`character`, `npc`) and items (`base`, `ability`, `equipment`, `weapon`).
- The `system.json` is configured with Foundry VTT URLs and licensed under `LICENSE.md`.
***
## Version 0.9.1

- No major mechanical or structural changes noted compared to 0.9.0.
- Note: internal label in the file was "0.9.1", which matches the canonical filename version.
***
## Version 0.9.2

- No major mechanical or structural changes noted compared to 0.9.1.
- Note: internal label in the file was "0.9.1", but filename is treated as canonical.
***
## Version 0.9.3

- No major mechanical or structural changes noted compared to 0.9.2.
- Note: internal label in the file was "0.9.1", but filename is treated as canonical.
***
## Version 0.9.4

- **New Essence Added:** The `ANIMA` essence is now included and displayed on the character sheet template, alongside Vitalis, Motus, Sensus, and Verbum.
- The sheet template for characters displays all five essences (`VITALIS`, `MOTUS`, `SENSUS`, `VERBUM`, `ANIMA`).
- Note: internal label in the file was "0.9.3", but filename is treated as canonical.
***
## Version 0.9.5

- No major structural changes noted compared to 0.9.4.
- Note: internal label in the file was "0.9.4", but filename is treated as canonical.
***
## Version 0.9.6

- No major structural changes noted compared to 0.9.5.
- Note: internal label in the file was "0.9.4", but filename is treated as canonical.
***
## Version 0.9.7

- **Sheet Restructure:** The Essence Grid display moved from being conditional (`{{#if (eq actor.type "character")}}`) to a **"UNIFIED ESSENCE GRID (PC & NPC)"** section.
- **Code Change:** Data access paths within the character sheet templates were generally updated from `{{system.essences...}}` (0.9.6) to `{{systemData.essences...}}`.
- Note: internal label in the file was "0.9.7", which matches the canonical filename version.
***
## Version 0.9.8

- No major structural changes noted compared to 0.9.7.
- Note: internal label in the file was "0.9.7", but filename is treated as canonical.
***
## Version 0.9.9

- No major structural changes noted compared to 0.9.8.
- Note: internal label in the file was "0.9.7", but filename is treated as canonical.
***
## Version 0.9.10

- **System Metadata:** The `system.json` file was significantly updated to include `authors`, `esmodules`, `styles`, `packs`, and `languages` arrays for better Foundry VTT integration.
- **Token Configuration:** Added `primaryTokenAttribute` (`resources.hp`) and `secondaryTokenAttribute` (`resources.action_surges`) parameters for token bars.
- **Compatibility:** Declared compatibility with Foundry VTT versions minimum "11" and verified "13".
- Note: internal label in the file was "0.9.10", which matches the canonical filename version.
***
## Version 0.9.11

- No major structural changes noted compared to 0.9.10.
- Note: internal label in the file was "0.9.10", but filename is treated as canonical.
***
## Version 0.9.12

- **New UI Tab:** A new "Calc" tab is added to the sheet navigation, indicating the introduction of an Interactive Resolution Calculator tool.
- **Item Mechanics Added:** Item sheets now include dropdowns for defining **Motor (E_P)** and **Quality (E_S)** essences for calculating item cost, applicable only if a cost is defined (Ability/Weapon).
- Note: internal label in the file was "v.9.12", but filename is treated as canonical.
***
## Version 0.9.13

- No major structural changes noted compared to 0.9.12.
- Note: internal label in the file was "v.9.12", but filename is treated as canonical.
***
## Version 0.9.14

- No major structural changes noted compared to 0.9.13.
- Note: internal label in the file was "v.9.12", but filename is treated as canonical.
***
## Version 0.9.15

- **Waning Mechanics UI:** Added a **"Trigger Waning Phase"** button visible only to PCs, integrating the key system decay mechanic.
- **New Tab Content:** The CALCULATOR TAB structure is displayed, including input fields for "My Roll (d100)", "Enemy Roll (d100)", "Enemy E_CUR", and "Enemy Tier (0-5)" for interactive resolution.
- **License Update:** The excerpts now include the specific Nárëquenta Limited Open License (v0.1) text.
- Note: internal label in the file was "v.9.15" or the earlier "v.9.12", but filename is treated as canonical.
***
## Version 0.9.16

- No major structural changes noted compared to 0.9.15.
- Note: internal label in the file was "v.9.12", but filename is treated as canonical.
***
## Version 0.9.17

- No major structural changes noted compared to 0.9.16.
- Note: internal label in the file was "v.9.12", but filename is treated as canonical.
***
## Version 0.9.18

- No major structural changes noted compared to 0.9.17.
- Note: internal label in the file was "v0.9.17" or "v.9.12", but filename is treated as canonical.
***
## Version 0.9.19 – not committed because of a small error.
***
## Version 0.9.20

- **Waning Phase UI Refinement:** The Waning process is now housed within a **"WANING SECTION (Toggle + Button)"**, introducing an "Enable Waning Phase" toggle option.
- Internal code comments reiterate the Core Axiom of **Proficiency Compensates for Decline**, and detail the Waning Roll mechanics: **Focus (2d6)** vs **Universal (1d6)** decay, including the **Tier I Guarantee** logic.
- Note: internal label in the file was "v0.9.19" or "v.9.12", but filename is treated as canonical.
***
## Version 0.9.21

- No major structural changes noted compared to 0.9.20.
- Note: internal label in the file was "v0.9.21", which matches the canonical filename version.
***
## Version 0.9.22

- **Waning Logic Implemented:** Code snippets now show the active implementation of the Waning process, including calculation of **loss percentage** (`${loss}%`) and communication via a chat message that details the _Focus_ and the percentage loss applied.
- Note: internal label in the file was "v0.9.22", which matches the canonical filename version.
***
## Version 0.9.23

- No major structural changes noted compared to 0.9.22.
- Note: internal label in the file was "v.9.12", but filename is treated as canonical.
***
## Version 0.9.24

- No major structural changes noted compared to 0.9.23.
- Note: internal label in the file was "v0.9.24", which matches the canonical filename version.
***
## Version 0.9.25

- No major structural changes noted compared to 0.9.24.
- Note: internal label in the file was "v0.9.25", which matches the canonical filename version.
***
## Version 0.9.26

- No major structural changes noted compared to 0.9.25.
- Note: internal label in the file was "v0.9.26", which matches the canonical filename version.
***
## Version 0.9.27

- **Metadata Clarification:** The author's email address in `system.json` was updated from `@proton.me` to `@gmail.com`.
- Note: internal label in the file was "v0.9.27", which matches the canonical filename version.
***
## Version 0.9.28

- No major structural changes noted compared to 0.9.27.
- Note: internal label in the file was "v0.9.28", which matches the canonical filename version.
***
## Version 0.9.29 – not committed because of a small error.
***
## Version 0.9.30

- No major structural changes noted compared to 0.9.28.
- Note: internal label in the file was "v0.9.30", which matches the canonical filename version.
***
## Version 0.9.31

- **Localization Updates:** Added new Portuguese (pt.json) localization strings for core prompts, including warnings for invalid attribute keys (`NAREQUENTA.NotifyAttrInvalid`) and confirmation prompts for deleting groups.
- Note: internal label in the file was "v0.9.31", which matches the canonical filename version.
***
## Version 0.9.32

- No major structural changes noted compared to 0.9.31.
- Note: internal label in the file was "v0.9.28" or "v0.9.31", but filename is treated as canonical.
***
## Version 0.9.33

- No major structural changes noted compared to 0.9.32.
- Note: internal label in the file was "v0.9.28", but filename is treated as canonical.
***
## Version 0.9.34

- No major structural changes noted compared to 0.9.33.
- Note: internal label in the file was "v0.9.28", but filename is treated as canonical.
***
## Version 0.9.35

- No major structural changes noted compared to 0.9.34.
- Note: internal label in the file was "v0.9.28", but filename is treated as canonical.
***
## Version 0.9.36

- No major structural changes noted compared to 0.9.35.
- Note: internal label in the file was "v0.9.28", but filename is treated as canonical.
***
## Version 0.9.37

- No major structural changes noted compared to 0.9.36.
- Note: internal label in the file was "v0.9.28", but filename is treated as canonical.
***
## Version 0.9.38

- No major structural changes noted compared to 0.9.37.
***- Note: internal label in the file was "v0.9.28", but filename is treated as canonical.

## Version 0.9.39 – not committed because of a small error.
***
## Version 0.9.40

- **Client Registration:** Added explicit registration of custom sheet classes for both Actors (`NarequentaActorSheet`) and Items (`SimpleItemSheet`) to Foundry VTT's configuration settings.
- Note: internal label in the file was "v0.9.39", but filename is treated as canonical.
***
## Version 0.9.41

- No major structural changes noted compared to 0.9.40.
- Note: internal label in the file was "v0.9.39", but filename is treated as canonical.
***
## Version 0.9.42

- **Template Change:** Added the `equipped_item_id` string field to the character template within `template.json`.
- Note: internal label in the file was "v0.9.42", which matches the canonical filename version.
***
## Version 0.9.43

- No major structural changes noted compared to 0.9.42.
- Note: internal label in the file was "v0.9.42", but filename is treated as canonical.
***
## Version 0.9.44

- No major structural changes noted compared to 0.9.43.
- Note: internal label in the file was "v0.9.42", but filename is treated as canonical.
***
## Version 0.9.45

- **New Item Mechanic: Weight Class:** Item sheets now include a **Weight Class** dropdown menu for items (Light - 10% Cost, Medium - 15% Cost, Heavy - 20% Cost), introducing a new mechanical parameter for item cost calculation.
- Note: internal label in the file was "v0.9.44", but filename is treated as canonical.
***
## Version 0.9.46

- No major structural changes noted compared to 0.9.45.
- Note: internal label in the file was "v0.9.44", but filename is treated as canonical.
***
## Version 0.9.47

- No major structural changes noted compared to 0.9.46.
- Note: internal label in the file was "v0.9.47", which matches the canonical filename version.
***
## Version 0.9.48

- No major structural changes noted compared to 0.9.47.
- Note: internal label in the file was "v0.9.48", which matches the canonical filename version.
***
## Version 0.9.49

- No major structural changes noted compared to 0.9.48.
- Note: internal label in the file was "v0.9.48", but filename is treated as canonical.
***
## Version 0.9.50

- No major structural changes noted compared to 0.9.49.
- Note: internal label in the file was "v0.9.50", which matches the canonical filename version.
***
## Version 0.9.51

- **Client Initialization:** The initialization code confirms setting the combat initiative formula (`1d10`, 2 decimals) and assigns custom classes for Actors, Items, and Tokens.
- Note: internal label in the file was "v0.9.51", which matches the canonical filename version.
***
## Version 0.9.52 – not committed because of a small error.
***
## Version 0.9.53

- **Weapon Template Update:** The `weapon` item type now includes a default `range` value of `2` in `template.json`.
- **UI Update:** The character sheet header section is refined to explicitly display the **Essence Current Value / HP** line.
- **New Damage Section:** A new sheet section labeled "APPLY DAMAGE & ATTRITION" is introduced, likely for immediate interaction with health/essence values.
- Note: internal label in the file was "v0.9.53", which matches the canonical filename version.
***
## Version 0.9.54

- No major structural changes noted compared to 0.9.53.
- Note: internal label in the file was "v0.9.54", which matches the canonical filename version.
***
## Version 0.9.55

- No major structural changes noted compared to 0.9.54.
- Note: internal label in the file was "v0.9.54", but filename is treated as canonical.
***
## Version 0.9.56

- **Recovery Mechanics Implemented:** Added full logic for **Short Rest (Refocus)** and **Long Rest (Renewal)** buttons in `actor-sheet.js`.
- **Refocus (Short Rest):** Opens a dialog to roll varying recovery dice (e.g., 1d6 for Quick Breath, 4d10 for Deep Meditation) and restores Essence/HP.
- **Renewal (Long Rest):** Resets all Essences and HP to their current Maximums, resets Action Surges (for PCs), and clears targeting data.
- **Manual Damage Handler:** Implemented the `_onApplySheetDamage` helper to allow direct manual adjustments to HP or Essence pools via a dialog.
***
## [v0.9.58] — 2025-11-30 (Visual Themes & Calculator Polish)
**Status:** Alpha - UI Polish

### 🎨 Visual Interface & Themes
- **Sheet Themes:** Implemented distinct visual themes based on actor type.
    - **Characters (PCs):** Green styling (Backgrounds, Borders, Text) to symbolize Life/Growth.
    - **Adversaries (NPCs):** Red styling to symbolize Threat/Blood.
- **Logic Coloring:** Applied specific colors to numerical inputs to reinforce system concepts (Red for $E_{max}$, Green for $E_{cur}$).

### 💻 Calculator Interface
- **Proficiency Input:** Converted the static "Proficiency" label in the resolution calculator into an editable number input.
- **Unit Display:** Updated the Item Selection dropdown in the calculator to display ranges in **Feet (ft)**.

***
## [v0.9.59] — 2025-11-30 (Item Sheet Restoration & Data Binding)
**Status:** Hotfix - UI Repair

### 🐛 Fixes
- **Item Sheet Rendering:** Fixed a critical issue where the Item Sheet would fail to render or appear blank. Replaced the legacy Worldbuilding template with a dedicated `item-sheet.html` structure.
- **Data Safety:** Updated `item-sheet.js` to use safe data retrieval methods (`this.document.toObject(false)`), preventing crashes when creating brand new items without pre-existing flags.

### 💻 Interface
- **Mechanics Header:** The Item Sheet header now includes dedicated inputs for **Weight (Attrition)**, **Range (ft)**, and **Damage/Heal Bonus**. These fields directly feed the Combat Calculator.
- **Essence Costs:** Added specific dropdowns in the "Details" tab to define the **Motor ($E_P$)** and **Quality ($E_S$)** Essence pair used by the item.
***
## [v0.9.60] — 2025-11-30 (Advanced Targeting & Combat Flow)
**Status:** Alpha - Feature Expansion

### 🎯 Tactical Targeting (AoE Safeguards)
- **Safeguard Logic:** Implemented Tier-based targeting for Area of Effect items in the Combat Calculator:
    - **Tier < 3 (Wild Magic):** Offensive AoE auto-selects **ALL** tokens in range (Friendly Fire risk).
    - **Tier ≥ 3 (Mastery):** Offensive AoE auto-selects **NPCs Only** (Safe Casting).
    - **Healing:** Always auto-selects **Allies (PCs)**.
- **Essence Sync:** Selecting a weapon now automatically sets the **Target Defense Stat** to match the weapon's **Motor Essence**, enforcing the rule that defenders must contest with the same Essence used by the attacker.

### ⚔️ Combat Flow Tools
- **End Turn:** Added a button to the sheet header to advance the Foundry Combat Tracker and automatically open the sheet of the next combatant.
- **Action Surge:** Added a dedicated "Lightning Bolt" button to spend Action Surges (PC Only), updating the resource and posting a dramatic notification to chat.

### 📦 Item Mechanics
- **Targeting Modes:** Implemented `target_type` logic (Self / Single Target / AoE).
    - **Self:** Consumables apply immediately to the user.
    - **Single Target:** Prompts a dialog to choose between "Self" (Drink) or "Administer/Throw".
***
## [v0.9.61] — 2025-11-30 (Universal Potions & Resource Routing)
**Status:** Alpha - Mechanics Depth

### 🧪 Universal Consumables
- **Resource Routing:** Items can now target specific pools beyond just HP. Added `target_resource` field to define if an item affects **Active Vigor (HP)** or a specific **Essence** (e.g., *Vitalis Balm* restores Vitalis).
- **Smart Application:** Updated `_onItemUse` to dynamically route healing or damage to the correct resource path based on the item's configuration.

### ⚔️ Combat Logic Fixes
- **Calculator Targeting:** Fixed a critical logic gap where damage calculated via the combat panel was always applying to the *Defensive Stat* used for the roll. It now correctly respects the item's `target_resource` (defaulting to HP for standard weapons).
- **End Turn:** Fixed the "End Turn" button to correctly close the current actor sheet after advancing the combat tracker.

### 💻 Interface
- **Item Sheet:** Added an "Affects" dropdown to the Item Sheet header, allowing GMs to configure whether an item targets HP or a specific Essence.
***
## [v0.9.62] — 2025-11-30 (Detailed Output & Smart Targeting)
**Status:** Alpha - UX Enhancement

### ⚔️ Combat Calculator Enhancements
- **Detailed Chat Log:** The calculator now outputs a structured HTML table to the Chat Log upon processing. This table lists every specific target, their individual Defense Roll (randomized or manual), and the calculated Damage/Healing result.
- **Visual Clarity:** Results in the chat are color-coded (Red for Damage, Green for Healing) to match the sheet interface.

### 🎯 Targeting Improvements
- **Smart Auto-Select:** Updated the Targeting Dialog (`_onLaunchContest`). If an item is flagged as **AoE**, the system now automatically pre-selects valid tokens based on the action type:
    - **Healing:** Auto-selects Allies (PCs).
    - **Damage (Tier < 3):** Auto-selects All (Wild Magic safeguard).
    - **Damage (Tier ≥ 3):** Auto-selects Enemies (NPCs) (Mastery safeguard).

### 🐛 UI Fixes
- **Item Sheet Layout:** Increased the width of the **Range** input field to `60px` to prevent text cutting off when entering long distances (e.g., "120").
***



###############################################################################
##                                                                          ###
##                               constants.js                               ###
##                                                                          ###
###############################################################################

export const ATTRIBUTE_TYPES = ["String", "Number", "Boolean", "Formula", "Resource"];

###############################################################################
##                                                                          ###
##                                 en.json                                  ###
##                                                                          ###
###############################################################################

{
  "NAREQUENTA.GameTitle": "Nárëquenta: Tales of the Waning",

  "SETTINGS.SimpleMacroShorthandN": "Shortened Macro Syntax",
  "SETTINGS.SimpleMacroShorthandL": "Enable shortened syntax. Allows referencing essences directly, for example @vitalis instead of @essences.vitalis.value.",
  "SETTINGS.SimpleInitFormulaN": "Initiative Formula",
  "SETTINGS.SimpleInitFormulaL": "Enter an initiative formula. Recommended: 1d10 + @essences.sensus.tier",

  "NAREQUENTA.ItemCreate": "Create Ability",
  "NAREQUENTA.ItemEdit": "Edit Ability",
  "NAREQUENTA.ItemDelete": "Delete Ability",
  "NAREQUENTA.ItemNew": "New Ability",

  "NAREQUENTA.NotifyInitFormulaUpdated": "Initiative formula updated to",
  "NAREQUENTA.NotifyInitFormulaInvalid": "Initiative formula was invalid",

  "NAREQUENTA.Health": "Hit Points",
  "NAREQUENTA.EssenceMax": "Soul's Peak",
  "NAREQUENTA.EssenceCur": "Active Vigor",
  "NAREQUENTA.EssenceTier": "Tier / Waning Yield",
  "NAREQUENTA.ActionSurges": "Surges of Intent",

  "NAREQUENTA.TabEssences": "Facets of the Self",
  "NAREQUENTA.TabAbilities": "Abilities & Gear",
  "NAREQUENTA.TabBiography": "The Legend (Bio)",
  "NAREQUENTA.TabPromise": "Final Vow",

  "NAREQUENTA.Vitalis": "VITALIS (Vigor, Presence)",
  "NAREQUENTA.Motus": "MOTUS (Movement, Finesse)",
  "NAREQUENTA.Sensus": "SENSUS (Awareness, Instinct)",
  "NAREQUENTA.Verbum": "VERBUM (Intellect, Logic)",
  "NAREQUENTA.Anima": "ANIMA (Will, Sacrifice)",

  "NAREQUENTA.DefineTemplate": "Define as Template",
  "NAREQUENTA.UnsetTemplate": "Unset Template",
  "NAREQUENTA.NoTemplate": "No Template",

  "NAREQUENTA.Create": "Create",
  "NAREQUENTA.New": "New",
  
  "NAREQUENTA.RollSuccess": "Success",
  "NAREQUENTA.RollFailure": "Failure",
  "NAREQUENTA.AttritionApplied": "Attrition Applied (Motor/Quality)",
  
  "NAREQUENTA.AttributeKey": "Attribute Key",
  "NAREQUENTA.AttributeValue": "Value",
  "NAREQUENTA.AttributeLabel": "Label",
  "NAREQUENTA.AttributeDtype": "Data Type",
  "NAREQUENTA.ResourceMin": "Min",
  "NAREQUENTA.ResourceValue": "Value",
  "NAREQUENTA.ResourceMax": "Max",

  "NAREQUENTA.NotifyAttrDuplicate": "Attribute key already exists as a group.",
  "NAREQUENTA.NotifyGroupDuplicate": "Attribute group already exists.",
  "NAREQUENTA.NotifyGroupAttrDuplicate": "Attribute group already exists as an attribute.",
  "NAREQUENTA.NotifyGroupReserved": "Attribute group \"{key}\" is reserved and cannot be used.",
  "NAREQUENTA.NotifyGroupAlphanumeric": "Attribute group names may not contain spaces or periods.",
  "NAREQUENTA.NotifyAttrInvalid": "Attribute keys may not contain spaces or periods.",
  
  "NAREQUENTA.DeleteGroup": "Delete group?",
  "NAREQUENTA.DeleteGroupContent": "Do you wish to delete this group? This will delete the following group and all attributes included in it: ",
  
  "Yes": "Yes",
  "No": "No"
}

###############################################################################
##                                                                          ###
##                               gulpfile.js                                ###
##                                                                          ###
###############################################################################

const gulp = require('gulp');
const less = require('gulp-less');

/* ----------------------------------------- */
/* Compile LESS
/* ----------------------------------------- */

// Update the constant to match your new file structure
const SYSTEM_LESS = ["styles/*.less"];

function compileLESS() {
  // Changed from "simple.less" to "narequenta.less"
  return gulp.src("styles/narequenta.less")
    .pipe(less())
    .pipe(gulp.dest("./styles/"))
}

const css = gulp.series(compileLESS);

/* ----------------------------------------- */
/* Watch Updates
/* ----------------------------------------- */

function watchUpdates() {
  gulp.watch(SYSTEM_LESS, css);
}

/* ----------------------------------------- */
/* Export Tasks
/* ----------------------------------------- */

exports.default = gulp.series(
  gulp.parallel(css),
  watchUpdates
);
exports.css = css;

###############################################################################
##                                                                          ###
##                                helper.js                                 ###
##                                                                          ###
###############################################################################

export class EntitySheetHelper {

  static getAttributeData(data) {
    // Determine attribute type.
    for ( let attr of Object.values(data.system.attributes) ) {
      if ( attr.dtype ) {
        attr.isCheckbox = attr.dtype === "Boolean";
        attr.isResource = attr.dtype === "Resource";
        attr.isFormula = attr.dtype === "Formula";
      }
    }

    // Initialize ungrouped attributes for later.
    data.system.ungroupedAttributes = {};

    // Build an array of sorted group keys.
    const groups = data.system.groups || {};
    let groupKeys = Object.keys(groups).sort((a, b) => {
      let aSort = groups[a].label ?? a;
      let bSort = groups[b].label ?? b;
      return aSort.localeCompare(bSort);
    });

    // Iterate over the sorted groups to add their attributes.
    for ( let key of groupKeys ) {
      let group = data.system.attributes[key] || {};

      // Initialize the attributes container for this group.
      if ( !data.system.groups[key]['attributes'] ) data.system.groups[key]['attributes'] = {};

      // Sort the attributes within the group, and then iterate over them.
      Object.keys(group).sort((a, b) => a.localeCompare(b)).forEach(attr => {
        // Avoid errors if this is an invalid group.
        if ( typeof group[attr] != "object" || !group[attr]) return;
        // For each attribute, determine whether it's a checkbox or resource, and then add it to the group's attributes list.
        group[attr]['isCheckbox'] = group[attr]['dtype'] === 'Boolean';
        group[attr]['isResource'] = group[attr]['dtype'] === 'Resource';
        group[attr]['isFormula'] = group[attr]['dtype'] === 'Formula';
        data.system.groups[key]['attributes'][attr] = group[attr];
      });
    }

    // Sort the remaining attributes.
    const keys = Object.keys(data.system.attributes).filter(a => !groupKeys.includes(a));
    keys.sort((a, b) => a.localeCompare(b));
    for ( const key of keys ) data.system.ungroupedAttributes[key] = data.system.attributes[key];

    // Modify attributes on items.
    if ( data.items ) {
      data.items.forEach(item => {
        // Iterate over attributes.
        for ( let [k, v] of Object.entries(item.system.attributes) ) {
          // Grouped attributes.
          if ( !v.dtype ) {
            for ( let [gk, gv] of Object.entries(v) ) {
              if ( gv.dtype ) {
                // Add label fallback.
                if ( !gv.label ) gv.label = gk;
                // Add formula bool.
                if ( gv.dtype === "Formula" ) {
                  gv.isFormula = true;
                }
                else {
                  gv.isFormula = false;
                }
              }
            }
          }
          // Ungrouped attributes.
          else {
            // Add label fallback.
            if ( !v.label ) v.label = k;
            // Add formula bool.
            if ( v.dtype === "Formula" ) {
              v.isFormula = true;
            }
            else {
              v.isFormula = false;
            }
          }
        }
      });
    }
  }

  /* -------------------------------------------- */

  /** @override */
  static onSubmit(event) {
    // Closing the form/sheet will also trigger a submit, so only evaluate if this is an event.
    if ( event.currentTarget ) {
      // Exit early if this isn't a named attribute.
      if ( (event.currentTarget.tagName.toLowerCase() === 'input') && !event.currentTarget.hasAttribute('name')) {
        return false;
      }

      let attr = false;
      // If this is the attribute key, we need to make a note of it so that we can restore focus when its recreated.
      const el = event.currentTarget;
      if ( el.classList.contains("attribute-key") ) {
        let val = el.value;
        let oldVal = el.closest(".attribute").dataset.attribute;
        let attrError = false;
        // Prevent attributes that already exist as groups.
        let groups = document.querySelectorAll('.group-key');
        for ( let i = 0; i < groups.length; i++ ) {
          if (groups[i].value === val) {
            ui.notifications.error(game.i18n.localize("NAREQUENTA.NotifyAttrDuplicate") + ` (${val})`);
            el.value = oldVal;
            attrError = true;
            break;
          }
        }
        // Handle value and name replacement otherwise.
        if ( !attrError ) {
          oldVal = oldVal.includes('.') ? oldVal.split('.')[1] : oldVal;
          attr = $(el).attr('name').replace(oldVal, val);
        }
      }

      // Return the attribute key if set, or true to confirm the submission should be triggered.
      return attr ? attr : true;
    }
  }

  /* -------------------------------------------- */

  /**
   * Listen for click events on an attribute control to modify the composition of attributes in the sheet
   * @param {MouseEvent} event    The originating left click event
   */
  static async onClickAttributeControl(event) {
    event.preventDefault();
    const a = event.currentTarget;
    const action = a.dataset.action;
    switch ( action ) {
      case "create":
        return EntitySheetHelper.createAttribute(event, this);
      case "delete":
        return EntitySheetHelper.deleteAttribute(event, this);
    }
  }

  /* -------------------------------------------- */

  /**
   * Listen for click events and modify attribute groups.
   * @param {MouseEvent} event    The originating left click event
   */
  static async onClickAttributeGroupControl(event) {
    event.preventDefault();
    const a = event.currentTarget;
    const action = a.dataset.action;
    switch ( action ) {
      case "create-group":
        return EntitySheetHelper.createAttributeGroup(event, this);
      case "delete-group":
        return EntitySheetHelper.deleteAttributeGroup(event, this);
    }
  }

  /* -------------------------------------------- */

  /**
   * Listen for the roll button on attributes.
   * @param {MouseEvent} event    The originating left click event
   */
  static onAttributeRoll(event) {
    event.preventDefault();
    const button = event.currentTarget;
    const label = button.closest(".attribute").querySelector(".attribute-label")?.value;
    const chatLabel = label ?? button.parentElement.querySelector(".attribute-key").value;
    const shorthand = game.settings.get("narequenta", "macroShorthand");

    // Use the actor for rollData so that formulas are always in reference to the parent actor.
    const rollData = this.actor.getRollData();
    let formula = button.closest(".attribute").querySelector(".attribute-value")?.value;

    // If there's a formula, attempt to roll it.
    if ( formula ) {
      let replacement = null;
      if ( formula.includes('@item.') && this.item ) {
        let itemName = this.item.name.slugify({strict: true}); // Get the machine safe version of the item name.
        replacement = !!shorthand ? `@items.${itemName}.` : `@items.${itemName}.attributes.`;
        formula = formula.replace('@item.', replacement);
      }

      // Create the roll and the corresponding message
      let r = new Roll(formula, rollData);
      return r.toMessage({
        user: game.user.id,
        speaker: ChatMessage.getSpeaker({ actor: this.actor }),
        flavor: `${chatLabel}`
      });
    }
  }

  /* -------------------------------------------- */

  /**
   * Return HTML for a new attribute to be applied to the form for submission.
   *
   * @param {Object} items  Keyed object where each item has a "type" and "value" property.
   * @param {string} index  Numeric index or key of the new attribute.
   * @param {string|boolean} group String key of the group, or false.
   *
   * @returns {string} Html string.
   */
  static getAttributeHtml(items, index, group = false) {
    // Initialize the HTML.
    let result = '<div style="display: none;">';
    // Iterate over the supplied keys and build their inputs (including whether they need a group key).
    for (let [key, item] of Object.entries(items)) {
      result = result + `<input type="${item.type}" name="system.attributes${group ? '.' + group : '' }.attr${index}.${key}" value="${item.value}"/>`;
    }
    // Close the HTML and return.
    return result + '</div>';
  }

  /* -------------------------------------------- */

  /**
   * Validate whether or not a group name can be used.
   * @param {string} groupName    The candidate group name to validate
   * @param {Document} document   The Actor or Item instance within which the group is being defined
   * @returns {boolean}
   */
  static validateGroup(groupName, document) {
    let groups = Object.keys(document.system.groups || {});
    let attributes = Object.keys(document.system.attributes).filter(a => !groups.includes(a));

    // Check for duplicate group keys.
    if ( groups.includes(groupName) ) {
      ui.notifications.error(game.i18n.localize("NAREQUENTA.NotifyGroupDuplicate") + ` (${groupName})`);
      return false;
    }

    // Check for group keys that match attribute keys.
    if ( attributes.includes(groupName) ) {
      ui.notifications.error(game.i18n.localize("NAREQUENTA.NotifyGroupAttrDuplicate") + ` (${groupName})`);
      return false;
    }

    // Check for reserved group names.
    if ( ["attr", "attributes"].includes(groupName) ) {
      ui.notifications.error(game.i18n.format("NAREQUENTA.NotifyGroupReserved", {key: groupName}));
      return false;
    }

    // Check for whitespace or periods.
    if ( groupName.match(/[\s|\.]/i) ) {
      ui.notifications.error(game.i18n.localize("NAREQUENTA.NotifyGroupAlphanumeric"));
      return false;
    }
    return true;
  }

  /* -------------------------------------------- */

  /**
   * Create new attributes.
   * @param {MouseEvent} event    The originating left click event
   * @param {Object} app          The form application object.
   * @private
   */
  static async createAttribute(event, app) {
    const a = event.currentTarget;
    const group = a.dataset.group;
    let dtype = a.dataset.dtype;
    const attrs = app.object.system.attributes;
    const groups = app.object.system.groups;
    const form = app.form;

    // Determine the new attribute key for ungrouped attributes.
    let objKeys = Object.keys(attrs).filter(k => !Object.keys(groups).includes(k));
    let nk = Object.keys(attrs).length + 1;
    let newValue = `attr${nk}`;
    let newKey = document.createElement("div");
    while ( objKeys.includes(newValue) ) {
      ++nk;
      newValue = `attr${nk}`;
    }

    // Build options for construction HTML inputs.
    let htmlItems = {
      key: {
        type: "text",
        value: newValue
      }
    };

    // Grouped attributes.
    if ( group ) {
      objKeys = attrs[group] ? Object.keys(attrs[group]) : [];
      nk = objKeys.length + 1;
      newValue = `attr${nk}`;
      while ( objKeys.includes(newValue) ) {
        ++nk;
        newValue =  `attr${nk}`;
      }

      // Update the HTML options used to build the new input.
      htmlItems.key.value = newValue;
      htmlItems.group = {
        type: "hidden",
        value: group
      };
      htmlItems.dtype = {
        type: "hidden",
        value: dtype
      };
    }
    // Ungrouped attributes.
    else {
      // Choose a default dtype based on the last attribute, fall back to "String".
      if (!dtype) {
        let lastAttr = document.querySelector('.attributes > .attributes-group .attribute:last-child .attribute-dtype')?.value;
        dtype = lastAttr ? lastAttr : "String";
        htmlItems.dtype = {
          type: "hidden",
          value: dtype
        };
      }
    }

    // Build the form elements used to create the new grouped attribute.
    newKey.innerHTML = EntitySheetHelper.getAttributeHtml(htmlItems, nk, group);

    // Append the form element and submit the form.
    newKey = newKey.children[0];
    form.appendChild(newKey);
    await app._onSubmit(event);
  }

  /**
   * Delete an attribute.
   * @param {MouseEvent} event    The originating left click event
   * @param {Object} app          The form application object.
   * @private
   */
  static async deleteAttribute(event, app) {
    const a = event.currentTarget;
    const li = a.closest(".attribute");
    if ( li ) {
      li.parentElement.removeChild(li);
      await app._onSubmit(event);
    }
  }

  /* -------------------------------------------- */

  /**
   * Create new attribute groups.
   * @param {MouseEvent} event    The originating left click event
   * @param {Object} app          The form application object.
   * @private
   */
  static async createAttributeGroup(event, app) {
    const a = event.currentTarget;
    const form = app.form;
    let newValue = $(a).siblings('.group-prefix').val();
    // Verify the new group key is valid, and use it to create the group.
    if ( newValue.length > 0 && EntitySheetHelper.validateGroup(newValue, app.object) ) {
      let newKey = document.createElement("div");
      newKey.innerHTML = `<input type="text" name="system.groups.${newValue}.key" value="${newValue}"/>`;
      // Append the form element and submit the form.
      newKey = newKey.children[0];
      form.appendChild(newKey);
      await app._onSubmit(event);
    }
  }

  /* -------------------------------------------- */

  /**
   * Delete an attribute group.
   * @param {MouseEvent} event    The originating left click event
   * @param {Object} app          The form application object.
   * @private
   */
  static async deleteAttributeGroup(event, app) {
    const a = event.currentTarget;
    let groupHeader = a.closest(".group-header");
    let groupContainer = groupHeader.closest(".group");
    let group = $(groupHeader).find('.group-key');
    // Create a dialog to confirm group deletion.
    new Dialog({
      title: game.i18n.localize("NAREQUENTA.DeleteGroup"),
      content: `${game.i18n.localize("NAREQUENTA.DeleteGroupContent")} <strong>${group.val()}</strong>`,
      buttons: {
        confirm: {
          icon: '<i class="fas fa-trash"></i>',
          label: game.i18n.localize("Yes"),
          callback: async () => {
            groupContainer.parentElement.removeChild(groupContainer);
            await app._onSubmit(event);
          }
        },
        cancel: {
          icon: '<i class="fas fa-times"></i>',
          label: game.i18n.localize("No"),
        }
      }
    }).render(true);
  }

  /* -------------------------------------------- */

  /**
   * Update attributes when updating an actor object.
   * @param {object} formData       The form data object to modify keys and values for.
   * @param {Document} document     The Actor or Item document within which attributes are being updated
   * @returns {object}              The updated formData object.
   */
  static updateAttributes(formData, document) {
    let groupKeys = [];

    // Handle the free-form attributes list
    const formAttrs = foundry.utils.expandObject(formData)?.system?.attributes || {};
    const attributes = Object.values(formAttrs).reduce((obj, v) => {
      let attrs = [];
      let group = null;
      // Handle attribute keys for grouped attributes.
      if ( !v["key"] ) {
        attrs = Object.keys(v);
        attrs.forEach(attrKey => {
          group = v[attrKey]['group'];
          groupKeys.push(group);
          let attr = v[attrKey];
          const k = this.cleanKey(v[attrKey]["key"] ? v[attrKey]["key"].trim() : attrKey.trim());
          delete attr["key"];
          // Add the new attribute if it's grouped, but we need to build the nested structure first.
          if ( !obj[group] ) {
            obj[group] = {};
          }
          obj[group][k] = attr;
        });
      }
      // Handle attribute keys for ungrouped attributes.
      else {
        const k = this.cleanKey(v["key"].trim());
        delete v["key"];
        // Add the new attribute only if it's ungrouped.
        if ( !group ) {
          obj[k] = v;
        }
      }
      return obj;
    }, {});

    // Remove attributes which are no longer used
    for ( let k of Object.keys(document.system.attributes) ) {
      if ( !attributes.hasOwnProperty(k) ) attributes[`-=${k}`] = null;
    }

    // Remove grouped attributes which are no longer used.
    for ( let group of groupKeys) {
      if ( document.system.attributes[group] ) {
        for ( let k of Object.keys(document.system.attributes[group]) ) {
          if ( !attributes[group].hasOwnProperty(k) ) attributes[group][`-=${k}`] = null;
        }
      }
    }

    // Re-combine formData
    formData = Object.entries(formData).filter(e => !e[0].startsWith("system.attributes")).reduce((obj, e) => {
      obj[e[0]] = e[1];
      return obj;
    }, {_id: document.id, "system.attributes": attributes});

    return formData;
  }

  /* -------------------------------------------- */

  /**
   * Update attribute groups when updating an actor object.
   * @param {object} formData       The form data object to modify keys and values for.
   * @param {Document} document     The Actor or Item document within which attributes are being updated
   * @returns {object}              The updated formData object.
   */
  static updateGroups(formData, document) {
    const formGroups = foundry.utils.expandObject(formData).system.groups || {};
    const documentGroups = Object.keys(document.system.groups || {});

    // Identify valid groups submitted on the form
    const groups = Object.entries(formGroups).reduce((obj, [k, v]) => {
      const validGroup = documentGroups.includes(k) || this.validateGroup(k, document);
      if ( validGroup )  obj[k] = v;
      return obj;
    }, {});

    // Remove groups which are no longer used
    for ( let k of Object.keys(document.system.groups)) {
      if ( !groups.hasOwnProperty(k) ) groups[`-=${k}`] = null;
    }

    // Re-combine formData
    formData = Object.entries(formData).filter(e => !e[0].startsWith("system.groups")).reduce((obj, e) => {
      obj[e[0]] = e[1];
      return obj;
    }, {_id: document.id, "system.groups": groups});
    return formData;
  }

  /* -------------------------------------------- */

  /**
   * @see ClientDocumentMixin.createDialog
   */
  static async createDialog(data={}, options={}) {

    // Collect data
    const documentName = this.metadata.name;
    const folders = game.folders.filter(f => (f.type === documentName) && f.displayed);
    const label = game.i18n.localize(this.metadata.label);
    const title = game.i18n.format("DOCUMENT.Create", {type: label});

    // Identify the template Actor types
    const collection = game.collections.get(this.documentName);
    const templates = collection.filter(a => a.getFlag("narequenta", "isTemplate")); // Changed flag scope
    const defaultType = this.TYPES.filter(t => t !== CONST.BASE_DOCUMENT_TYPE)[0] ?? CONST.BASE_DOCUMENT_TYPE;
    const types = {
      [defaultType]: game.i18n.localize("NAREQUENTA.NoTemplate")
    }
    for ( let a of templates ) {
      types[a.id] = a.name;
    }

    // Render the document creation form
    const template = "templates/sidebar/document-create.html";
    const html = await renderTemplate(template, {
      name: data.name || game.i18n.format("DOCUMENT.New", {type: label}),
      folder: data.folder,
      folders: folders,
      hasFolders: folders.length > 1,
      type: data.type || templates[0]?.id || "",
      types: types,
      hasTypes: true
    });

    // Render the confirmation dialog window
    return Dialog.prompt({
      title: title,
      content: html,
      label: title,
      callback: html => {

        // Get the form data
        const form = html[0].querySelector("form");
        const fd = new FormDataExtended(form);
        let createData = fd.object;

        // Merge with template data
        const template = collection.get(form.type.value);
        if ( template ) {
          createData = foundry.utils.mergeObject(template.toObject(), createData);
          createData.type = template.type;
          delete createData.flags.narequenta.isTemplate; // Changed flag scope
        }

        // Merge provided override data
        createData = foundry.utils.mergeObject(createData, data, { inplace: false });
        return this.create(createData, {renderSheet: true});
      },
      rejectClose: false,
      options: options
    });
  }

  /* -------------------------------------------- */

  /**
   * Ensure the resource values are within the specified min and max.
   * @param {object} attrs  The Document's attributes.
   */
  static clampResourceValues(attrs) {
    const flat = foundry.utils.flattenObject(attrs);
    for ( const [attr, value] of Object.entries(flat) ) {
      const parts = attr.split(".");
      if ( parts.pop() !== "value" ) continue;
      const current = foundry.utils.getProperty(attrs, parts.join("."));
      if ( current?.dtype !== "Resource" ) continue;
      foundry.utils.setProperty(attrs, attr, Math.clamped(value, current.min || 0, current.max || 0));
    }
  }

  /* -------------------------------------------- */

  /**
   * Clean an attribute key, emitting an error if it contained invalid characters.
   * @param {string} key  The key to clean.
   * @returns {string}
   */
  static cleanKey(key) {
    const clean = key.replace(/[\s.]/g, "");
    if ( clean !== key ) ui.notifications.error("NAREQUENTA.NotifyAttrInvalid", { localize: true });
    return clean;
  }
}

###############################################################################
##                                                                          ###
##                             item-sheet.html                              ###
##                                                                          ###
###############################################################################

<form class="{{cssClass}}" autocomplete="off">
    
    {{!-- ================================================================= --}}
    {{!-- HEADER: Identity & Core Mechanics                                 --}}
    {{!-- ================================================================= --}}
    <header class="sheet-header">
        
        {{!-- Item Icon: Click to open file picker and upload image --}}
        <img class="profile-img" src="{{item.img}}" data-edit="img" title="{{item.name}}"/>
        
        <div class="header-fields">
            {{!-- Item Name --}}
            <h1 class="charname">
                <input name="name" type="text" value="{{item.name}}" placeholder="Name"/>
            </h1>
            
            {{!-- MECHANICS GRID: Top row of stats used by the Calculator --}}
            <div class="resource-row" style="display: flex; gap: 10px; align-items: center; margin-top: 5px;">
                
                {{!-- 
                   Weight (Attrition):
                   Used in formula: Cost = max(0, Weight - floor(R_prof/2)).
                   Standard values: Light (10), Medium (15), Heavy (20).
                   Zero (0) indicates a Potion/Consumable (Fixed Potency).
                --}}
                <div class="resource">
                    <label>Weight:</label>
                    <input type="number" name="system.weight" value="{{systemData.weight}}" placeholder="15" style="width: 50px; text-align: center;">
                </div>

                {{!-- 
                   Range (ft):
                   Used by the Tactical Targeting system to filter valid targets.
                   Defaults to 5 (Melee).
                --}}
                <div class="resource">
                    <label>Range (ft):</label>
                    <input type="number" name="system.range" value="{{systemData.range}}" placeholder="5" style="width: 60px; text-align: center;">
                </div>

                {{!-- 
                   Target Type:
                   Determines how the 'Use' button behaves.
                   - One: Prompts "Self or Administer?"
                   - AoE: Opens targeting dialog with Auto-Select logic.
                   - Self: Applies immediately to user.
                --}}
                <div class="resource">
                    <label>Target:</label>
                    <select name="system.target_type" style="height: 22px; font-size: 0.8em;">
                        {{#select systemData.target_type}}
                        <option value="one">Single Target</option>
                        <option value="aoe">Area (AoE)</option>
                        <option value="self">Self Only</option>
                        {{/select}}
                    </select>
                </div>

                {{!-- 
                   Affects (Target Resource):
                   Determines WHICH pool is damaged or healed on the target.
                   - HP: Standard damage/healing.
                   - Essences: Specific restoration (e.g. Vitalis Balm) or damage.
                --}}
                <div class="resource">
                    <label>Affects:</label>
                    <select name="system.target_resource" style="height: 22px; font-size: 0.8em;">
                        {{#select systemData.target_resource}}
                        <option value="hp">HP</option>
                        <option value="vitalis">VITALIS</option>
                        <option value="motus">MOTUS</option>
                        <option value="sensus">SENSUS</option>
                        <option value="verbum">VERBUM</option>
                        <option value="anima">ANIMA</option>
                        {{/select}}
                    </select>
                </div>
            </div>
            
            {{!-- 
               Damage/Heal Formula:
               Accepts dice formulas (e.g., "1d8 + 2") or static numbers.
               - Positive: Damage.
               - Negative (e.g., "-1d4"): Healing.
            --}}
            <div class="resource-row" style="margin-top: 5px;">
                 <label style="font-weight:bold; margin-right:5px;">Dmg/Heal Formula:</label>
                 <input type="text" name="system.damage_bonus" value="{{systemData.damage_bonus}}" placeholder="e.g. -1d4 (Heal) or 2 (Damage)" style="flex:1;">
            </div>
        </div>
    </header>

    {{!-- ================================================================= --}}
    {{!-- NAVIGATION TABS                                                   --}}
    {{!-- ================================================================= --}}
    <nav class="sheet-tabs tabs" data-group="primary">
        <a class="item" data-tab="description">{{localize "Description"}}</a>
        <a class="item" data-tab="details">{{localize "Details"}}</a>
        <a class="item" data-tab="attributes">{{localize "Attributes"}}</a>
    </nav>

    {{!-- ================================================================= --}}
    {{!-- SHEET BODY                                                        --}}
    {{!-- ================================================================= --}}
    <section class="sheet-body">

        {{!-- 1. DESCRIPTION TAB: Rich Text --}}
        <div class="tab" data-group="primary" data-tab="description">
            {{editor descriptionHTML target="system.description" button=true editable=editable engine="prosemirror"}}
        </div>

        {{!-- 2. DETAILS TAB: Essence Costs --}}
        <div class="tab" data-group="primary" data-tab="details">
            <div class="essence-grid-container">
                <h3 style="border-bottom: 1px solid #333; margin-bottom: 10px;">Action Costs & Scaling</h3>
                
                {{!-- 
                   Motor Essence ($E_P):
                   The primary stat used for the action. 
                   Takes the Variable Attrition Cost.
                   Sets the default Defensive Stat for the contest.
                --}}
                <div class="form-group">
                    <label><strong>Motor Essence ($E_P$):</strong></label>
                    <select name="system.cost.motor" style="width: 100%;">
                        {{#select systemData.cost.motor}}
                        {{#each systemData.essencesList as |label key|}}
                            <option value="{{key}}">{{label}}</option>
                        {{/each}}
                        {{/select}}
                    </select>
                </div>

                {{!-- 
                   Quality Essence ($E_S$):
                   The secondary stat. Takes a fixed 1% Attrition Cost.
                --}}
                <div class="form-group" style="margin-top: 10px;">
                    <label><strong>Quality Essence ($E_S$):</strong></label>
                    <select name="system.cost.quality" style="width: 100%;">
                        {{#select systemData.cost.quality}}
                        {{#each systemData.essencesList as |label key|}}
                            <option value="{{key}}">{{label}}</option>
                        {{/each}}
                        {{/select}}
                    </select>
                </div>
            </div>
        </div>

        {{!-- 3. ATTRIBUTES TAB: Legacy support for custom fields --}}
        <div class="tab attributes" data-group="primary" data-tab="attributes">
            {{> "systems/narequenta/templates/parts/sheet-groups.html"}}
        </div>
    </section>
</form>

###############################################################################
##                                                                          ###
##                              item-sheet.js                               ###
##                                                                          ###
###############################################################################

import { EntitySheetHelper } from "./helper.js";
import { ATTRIBUTE_TYPES } from "./constants.js";

/**
 * Nárëquenta Item Sheet Class
 * Extends the basic Foundry ItemSheet to support specific mechanics:
 * - Weight-based Attrition
 * - Essence Pairing (Motor/Quality)
 * - Targeting Logic (AoE, Self, Resource Routing)
 * @extends {ItemSheet}
 */
export class SimpleItemSheet extends ItemSheet {

  /** * Define default configuration options for the sheet.
   * @inheritdoc 
   */
  static get defaultOptions() {
    return foundry.utils.mergeObject(super.defaultOptions, {
      classes: ["narequenta", "sheet", "item"],
      // Point to the specific HTML template for items
      template: "systems/narequenta/templates/item-sheet.html",
      width: 520,
      height: 480,
      // Define navigation tabs. Default opens to 'Description'.
      tabs: [{navSelector: ".sheet-tabs", contentSelector: ".sheet-body", initial: "description"}],
      // Allow scrolling in the attributes tab
      scrollY: [".attributes"],
    });
  }

  /** * Prepare data for rendering the Handlebars template.
   * This is where we inject default values and dropdown options.
   * @inheritdoc 
   */
  async getData(options) {
    // 1. Retrieve the standard context from the parent class
    const context = await super.getData(options);
    
    // 2. SAFE DATA RETRIEVAL
    // We use this.document.toObject(false) to get a plain JavaScript object of the item's data.
    // This allows us to modify 'sourceData' in memory before sending it to the HTML
    // without accidentally triggering database updates on the server.
    const sourceData = this.document.toObject(false);
    
    // 3. INITIALIZE MISSING COLLECTIONS
    // If this is a brand new item, these objects might be undefined in the database.
    // We initialize them to prevent crashes in the EntitySheetHelper or HTML loops.
    if (!sourceData.system.attributes) sourceData.system.attributes = {};
    if (!sourceData.system.groups) sourceData.system.groups = {};
    
    // 4. SET DEFAULT VALUES (v0.9.6 Logic)
    // These defaults ensure the Combat Calculator works even if the user hasn't edited the item yet.
    
    // Weight: Defaults to 15 (Medium Class).
    // Formula Reference: Attrition = max(0, Weight - floor(R_prof/2))
    if (typeof sourceData.system.weight === "undefined") sourceData.system.weight = 15;
    
    // Range: Defaults to 5ft (Standard Melee Square).
    if (typeof sourceData.system.range === "undefined") sourceData.system.range = 5;
    
    // Cost Pair: Defaults to Vitalis (Force) + Motus (Movement), the standard physical action.
    if (!sourceData.system.cost) sourceData.system.cost = { motor: "vitalis", quality: "motus" };

    // Target Type: Defaults to Single Target ("one"). Options: self, one, aoe.
    if (!sourceData.system.target_type) sourceData.system.target_type = "one";

    // Target Resource: Defaults to HP ("hp"). Options: hp, vitalis, motus, etc.
    // This determines where damage/healing is applied when the item is used.
    if (!sourceData.system.target_resource) sourceData.system.target_resource = "hp";

    // 5. Pass data to Handlebars context
    // 'systemData' is a shortcut for the template to access system fields easily.
    context.systemData = sourceData.system;
    context.dtypes = ATTRIBUTE_TYPES;

    // 6. Essence Dropdown Options
    // Used in the 'Details' tab for selecting Motor/Quality pairs.
    // Maps the internal key (vitalis) to the readable label (VITALIS (Force)).
    context.systemData.essencesList = {
        "vitalis": "VITALIS (Force)",
        "motus": "MOTUS (Reflex)",
        "sensus": "SENSUS (Instinct)",
        "verbum": "VERBUM (Logic)",
        "anima": "ANIMA (Will)"
    };

    // 7. Text Editor Enrichment
    // Converts Foundry secrets, entity links (@Actor[...]), and formatting for the description.
    context.descriptionHTML = await TextEditor.enrichHTML(context.systemData.description, {
      secrets: this.document.isOwner,
      async: true
    });

    return context;
  }

  /** * Activate event listeners for interactivity.
   * Handles clicks, drags, and inputs on the sheet.
   * @inheritdoc 
   */
  activateListeners(html) {
    super.activateListeners(html);
    
    // Exit immediately if the sheet is locked (e.g., player viewing an item they don't own)
    if ( !this.isEditable ) return;

    // Attribute Management (Legacy Worldbuilding features)
    // These listeners handle the "Attributes" tab (Add/Delete custom stats).
    // The logic is offloaded to the Helper class to keep this file clean.
    html.find(".attributes").on("click", ".attribute-control", EntitySheetHelper.onClickAttributeControl.bind(this));
    html.find(".groups").on("click", ".group-control", EntitySheetHelper.onClickAttributeGroupControl.bind(this));
    
    // Draggable Attributes
    // Allows players to drag a custom attribute to the Macro Bar to create a roll macro.
    html.find(".attributes a.attribute-roll").each((i, a) => {
      a.setAttribute("draggable", true);
      a.addEventListener("dragstart", ev => {
        let dragData = ev.currentTarget.dataset;
        ev.dataTransfer.setData('text/plain', JSON.stringify(dragData));
      }, false);
    });
  }

  /** * Handle form submission updates.
   * This function runs before the data is saved to the database.
   * @override 
   */
  _getSubmitData(updateData) {
    // 1. Get the standard form data (inputs)
    let formData = super._getSubmitData(updateData);
    
    // 2. Process Custom Attributes via Helper
    // This ensures that any custom attributes defined in the "Attributes" tab 
    // are correctly structured and saved into the system.attributes object.
    formData = EntitySheetHelper.updateAttributes(formData, this.object);
    formData = EntitySheetHelper.updateGroups(formData, this.object);
    
    return formData;
  }
}

###############################################################################
##                                                                          ###
##                                 item.js                                  ###
##                                                                          ###
###############################################################################

import {EntitySheetHelper} from "./helper.js";

/**
 * Extend the base Item document to support attributes and groups with a custom template creation dialog.
 * @extends {Item}
 */
export class SimpleItem extends Item {

  /** @inheritdoc */
  prepareDerivedData() {
    super.prepareDerivedData();
    this.system.groups = this.system.groups || {};
    this.system.attributes = this.system.attributes || {};
    EntitySheetHelper.clampResourceValues(this.system.attributes);
  }

  /* -------------------------------------------- */

  /** @override */
  static async createDialog(data={}, options={}) {
    return EntitySheetHelper.createDialog.call(this, data, options);
  }

  /* -------------------------------------------- */

  /**
   * Is this Item used as a template for other Items?
   * @type {boolean}
   */
  get isTemplate() {
    return !!this.getFlag("narequenta", "isTemplate"); // Changed flag scope
  }
}

###############################################################################
##                                                                          ###
##                                LICENSE.md                                ###
##                                                                          ###
###############################################################################

# 🕯️ Nárëquenta — Tales of the Waning
### Nárëquenta Limited Open License (v0.1) & Software Credits

**Copyright © 2025 Serelith Varn**
All rights reserved.

---

## Part I: Creative Identity & Game System (IP)

### 1. Ownership
All creative text, terminology (e.g., "Vitalis", "Motus", "The Waning"), mechanics-as-expressed, setting concepts, and presentation of *Nárëquenta — Tales of the Waning* are the sole intellectual property of **Serelith Varn**.

### 2. Terms of Use for the Game
You are granted a **non-exclusive, royalty-free license** to:
- Read, learn, and play this system privately or publicly.
- Record, stream, or publish actual-play sessions using this system.
- Create and share **fan-made or homebrew content** provided you credit **Serelith Varn** and do not use it commercially.

You **may not** sell, monetize, or commercially distribute this system or its unique creative assets without a separate written agreement.

---

## Part II: Software License & Acknowledgments (Codebase)

### 1. System Derivation
This Foundry VTT system implementation is a derivative work based on the **Simple Worldbuilding System**.
Code structure, Handlebars templates, and core data architecture are adapted from the original work by **Atropos** and the **Foundry Gaming Network**.

### 2. The MIT License (Software Code)
Portions of the software code in this repository are licensed under the MIT License, inherited from the Simple Worldbuilding System.

**Copyright (c) 2020 Foundry Network**

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

---

> “We begin perfect, and fade with grace.
> This license ensures that our echoes remain ours, while honoring the foundation we build upon.”

###############################################################################
##                                                                          ###
##                                 macro.js                                 ###
##                                                                          ###
###############################################################################

/**
 * Create a Macro from an attribute drop.
 * Get an existing worldbuilding macro if one exists, otherwise create a new one.
 * @param {Object} data     The dropped data
 * @param {number} slot     The hotbar slot to use
 * @returns {Promise}
 */
export async function createWorldbuildingMacro(data, slot) {
  if ( !data.roll || !data.label ) return false;
  const command = `const roll = new Roll("${data.roll}", actor ? actor.getRollData() : {});
  roll.toMessage({speaker, flavor: "${data.label}"});`;
  let macro = game.macros.find(m => (m.name === data.label) && (m.command === command));
  if (!macro) {
    macro = await Macro.create({
      name: data.label,
      type: "script",
      command: command,
      flags: { "worldbuilding.attrMacro": true }
    });
  }
  game.user.assignHotbarMacro(macro, slot);
  return false;
}


###############################################################################
##                                                                          ###
##                              narequenta.css                              ###
##                                                                          ###
###############################################################################

/* GLOBAL SETTINGS */
.narequenta .window-content {
    font-family: "Signika", sans-serif;
    font-size: 14px;
    color: #191813;
    background: #fcfcfc;
}

/* HEADER */
.narequenta header.sheet-header {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
    border-bottom: 2px solid #333;
    padding-bottom: 10px;
}
.narequenta .profile-img {
    flex: 0 0 100px;
    height: 100px;
    margin-right: 15px;
    border: 2px solid #333;
    background-color: #4b4a44;
    border-radius: 5px;
    object-fit: cover;
    cursor: pointer;
}
.narequenta .header-fields { flex: 1; }
.narequenta h1.charname input {
    font-family: "Modesto Condensed", serif;
    font-size: 2em;
    border: none;
    border-bottom: 1px solid #000;
    width: 100%;
}
.narequenta .resource-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 5px 0;
}
.narequenta .resource { display: flex; align-items: center; gap: 5px; }
.narequenta .resource label { font-weight: bold; margin-right: 5px; }
.narequenta .rest-btn {
    background: #444; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.9em; cursor: pointer; border: 1px solid #000;
}
.narequenta .rest-btn:hover { background: #666; text-shadow: 0 0 2px #fff; }

/* TABS */
.narequenta .sheet-tabs {
    flex: 0 0 40px; border-top: 1px solid #AAA; border-bottom: 1px solid #AAA; line-height: 40px; margin-bottom: 10px;
}
.narequenta .sheet-tabs .item {
    display: inline-block; padding: 0 10px; border-bottom: 3px solid transparent; color: #4b4a44; font-weight: bold;
}
.narequenta .sheet-tabs .item.active { border-bottom: 3px solid #444; color: #191813; text-shadow: 0 0 2px #FFF; }
.narequenta .sheet-tabs .item:hover { color: #000; text-shadow: 0 0 2px #FFF; }

/* ESSENCE GRID */
.narequenta .essence-grid-container {
    border: 1px solid #bbb; background: rgba(0, 0, 0, 0.05); padding: 5px; border-radius: 5px; margin-bottom: 15px;
}
.narequenta .essence-header, .narequenta .essence-row {
    display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr; gap: 5px; align-items: center; padding: 4px;
}
.narequenta .essence-header { font-weight: bold; border-bottom: 1px solid #333; margin-bottom: 5px; font-size: 0.9em; text-transform: uppercase; }
.narequenta .essence-row { border-bottom: 1px solid #e0e0e0; }
.narequenta .essence-row:last-child { border-bottom: none; }
.narequenta .essence-label { font-weight: bold; color: #4a4a4a; }

/* INPUTS */
.narequenta input[type="number"] {
    text-align: center; background: rgba(255, 255, 255, 0.5); border: 1px solid #7a7971; border-radius: 3px;
}
.narequenta .input-emax { color: #8b0000; font-weight: bold; } /* Red for Limit */
.narequenta .input-ecur { color: #006400; font-weight: bold; } /* Green for Energy */
.narequenta .derived-stat { text-align: center; background: transparent; border: none; color: #555; font-style: italic; pointer-events: none; }

/* BUTTONS */
.narequenta .roll-calculation:hover, .narequenta .execute-batch:hover { opacity: 0.9; cursor: pointer; }
.narequenta .roll-calc-btn { background: #ddd; border: 1px solid #999; border-radius: 3px; padding: 0 5px; cursor: pointer; color: #333; }
.narequenta .roll-calc-btn:hover { background: #ccc; color: #000; }
.narequenta .end-turn:hover { background-color: #000 !important; color: #ffcc00 !important; box-shadow: 0 0 5px #ffcc00; }
.narequenta .use-action-surge:hover { text-shadow: 0 0 5px #d4af37; transform: scale(1.1); transition: all 0.2s; }

/* ITEM LIST */
.narequenta .items-list { list-style: none; margin: 0; padding: 0; }
.narequenta .item-header { background: rgba(0,0,0,0.05); border: 1px solid #aaa; font-weight: bold; padding: 5px; }
.narequenta .item { padding: 5px; border-bottom: 1px solid #ccc; background: rgba(255,255,255,0.2); }
.narequenta .item .item-image { flex: 0 0 24px; margin-right: 5px; }
.narequenta .item .item-name { flex: 1; margin: 0; line-height: 24px; }
.narequenta .item .rollable { color: #333; }
.narequenta .item .rollable:hover { color: #000; text-shadow: 0 0 2px #fff; }
.narequenta .item-controls { flex: 0 0 50px; text-align: right; }
.narequenta .item-controls a { margin-left: 5px; color: #555; }

/* THEMES */
/* PC (Green) */
.narequenta form.character { background-color: #f0fdf4 !important; }
.narequenta form.character header.sheet-header { border-bottom-color: #006400; }
.narequenta form.character .profile-img { border-color: #006400; background-color: #1a4d1a; }
.narequenta form.character .essence-header { border-bottom-color: #006400; color: #006400; }
.narequenta form.character .derived-stat { color: #004d00; }

/* NPC (Red) */
.narequenta form.npc { background-color: #fff5f5 !important; }
.narequenta form.npc header.sheet-header { border-bottom-color: #8b0000; }
.narequenta form.npc .profile-img { border-color: #8b0000; background-color: #4d1a1a; }
.narequenta form.npc .essence-header { border-bottom-color: #8b0000; color: #8b0000; }
.narequenta form.npc .tab.essences .essence-grid-container:nth-child(2) { background: rgba(139, 0, 0, 0.05); border-color: #8b0000; }
.narequenta form.npc .derived-stat { color: #4d0000; }

###############################################################################
##                                                                          ###
##                              narequenta.js                               ###
##                                                                          ###
###############################################################################

/**
 * Nárëquenta — Tales of the Waning
 * System Entry Point
 */

import { NarequentaActor } from "./actor.js";
import { SimpleItem } from "./item.js"; 
import { SimpleItemSheet } from "./item-sheet.js";
import { NarequentaActorSheet } from "./actor-sheet.js";
import { preloadHandlebarsTemplates } from "./templates.js";
import { createWorldbuildingMacro } from "./macro.js";
import { SimpleToken, SimpleTokenDocument } from "./token.js";

/* -------------------------------------------- */
/* Foundry VTT Initialization                   */
/* -------------------------------------------- */

Hooks.once("init", async function() {
  console.log(`Initializing Nárëquenta System`);

  CONFIG.Combat.initiative = {
    formula: "1d10",
    decimals: 2
  };

  game.narequenta = {
    NarequentaActor,
    createWorldbuildingMacro
  };

  CONFIG.Actor.documentClass = NarequentaActor;
  CONFIG.Item.documentClass = SimpleItem;
  CONFIG.Token.documentClass = SimpleTokenDocument;
  CONFIG.Token.objectClass = SimpleToken;

  Actors.unregisterSheet("core", ActorSheet);
  Actors.registerSheet("narequenta", NarequentaActorSheet, { makeDefault: true });
  Items.unregisterSheet("core", ItemSheet);
  Items.registerSheet("narequenta", SimpleItemSheet, { makeDefault: true });

  game.settings.register("narequenta", "macroShorthand", {
    name: "SETTINGS.SimpleMacroShorthandN",
    hint: "SETTINGS.SimpleMacroShorthandL",
    scope: "world",
    type: Boolean,
    default: true,
    config: true
  });

  game.settings.register("narequenta", "initFormula", {
    name: "SETTINGS.SimpleInitFormulaN",
    hint: "SETTINGS.SimpleInitFormulaL",
    scope: "world",
    type: String,
    default: "1d10",
    config: true,
    onChange: formula => _simpleUpdateInit(formula, true)
  });

  const initFormula = game.settings.get("narequenta", "initFormula");
  _simpleUpdateInit(initFormula);

  function _simpleUpdateInit(formula, notify = false) {
    const isValid = Roll.validate(formula);
    if ( !isValid ) {
      if ( notify ) ui.notifications.error(`${game.i18n.localize("NAREQUENTA.NotifyInitFormulaInvalid")}: ${formula}`);
      return;
    }
    CONFIG.Combat.initiative.formula = formula;
  }

  Handlebars.registerHelper('slugify', function(value) {
    return value.slugify({strict: true});
  });

  await preloadHandlebarsTemplates();
});

Hooks.on("hotbarDrop", (bar, data, slot) => createWorldbuildingMacro(data, slot));


###############################################################################
##                                                                          ###
##                             narequenta.less                              ###
##                                                                          ###
###############################################################################

/* ========================================================================
   NÁRËQUENTA SYSTEM STYLES (LESS SOURCE)
   ======================================================================== */

/* --- Variables --- */
@color-text: #191813;
@color-bg: #fcfcfc;
@color-border: #333;
@color-light-gray: #e0e0e0;
@color-faint-gray: rgba(0, 0, 0, 0.05);

/* Logic Colors */
@color-emax: #8b0000; /* Dark Red - Represents Limit/Loss */
@color-ecur: #006400; /* Dark Green - Represents Energy/Life */

/* Theme Colors */
@theme-pc-bg: #f0fdf4;
@theme-pc-border: #006400;
@theme-npc-bg: #fff5f5;
@theme-npc-border: #8b0000;

/* ------------------------------------------------------------------------
   GLOBAL WINDOW STYLES
   ------------------------------------------------------------------------ */
.narequenta {
    .window-content {
        font-family: "Signika", sans-serif;
        font-size: 14px;
        color: @color-text;
        background: @color-bg;
    }

    /* --------------------------------------------------------------------
       SHEET HEADER (Avatar, Name, Resources)
       -------------------------------------------------------------------- */
    header.sheet-header {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        border-bottom: 2px solid @color-border;
        padding-bottom: 10px;

        /* Profile Image Container */
        .profile-img {
            flex: 0 0 100px;
            height: 100px;
            margin-right: 15px;
            border: 2px solid @color-border;
            background-color: #4b4a44;
            border-radius: 5px;
            object-fit: cover;
            cursor: pointer; /* Indicates clickable for image upload */
        }

        .header-fields {
            flex: 1;
        }

        /* Character Name Input (Stylish Font) */
        h1.charname input {
            font-family: "Modesto Condensed", serif;
            font-size: 2em;
            border: none;
            border-bottom: 1px solid #000;
            width: 100%;
        }
        
        /* Resource Rows (HP, Action Surges, Rest Buttons) */
        .resource-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 5px 0;

            .resource {
                display: flex;
                align-items: center;
                gap: 5px;
                
                label {
                    font-weight: bold;
                    margin-right: 5px;
                }
            }
        }
        
        /* Rest Buttons (Icons + Text) */
        .rest-btn {
            background: #444;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            cursor: pointer;
            border: 1px solid #000;
            
            &:hover {
                background: #666;
                text-shadow: 0 0 2px #fff;
            }
        }
    }

    /* --------------------------------------------------------------------
       NAVIGATION TABS
       -------------------------------------------------------------------- */
    .sheet-tabs {
        flex: 0 0 40px;
        border-top: 1px solid #AAA;
        border-bottom: 1px solid #AAA;
        line-height: 40px;
        margin-bottom: 10px;

        .item {
            display: inline-block;
            padding: 0 10px;
            border-bottom: 3px solid transparent;
            color: #4b4a44;
            font-weight: bold;

            &.active {
                border-bottom: 3px solid #444;
                color: @color-text;
                text-shadow: 0 0 2px #FFF;
            }

            &:hover {
                color: #000;
                text-shadow: 0 0 2px #FFF;
            }
        }
    }

    /* --------------------------------------------------------------------
       ESSENCE GRID (The Core Mechanic Display)
       -------------------------------------------------------------------- */
    .essence-grid-container {
        border: 1px solid #bbb;
        background: @color-faint-gray;
        padding: 5px;
        border-radius: 5px;
        margin-bottom: 15px;

        /* Header Row Grid Definition */
        .essence-header {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr; /* Label | Max | Cur | Tier | Dice */
            gap: 5px;
            align-items: center;
            padding: 4px;
            font-weight: bold;
            border-bottom: 1px solid @color-border;
            margin-bottom: 5px;
            font-size: 0.9em;
            text-transform: uppercase;
        }

        /* Data Row Grid Definition */
        .essence-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
            gap: 5px;
            align-items: center;
            padding: 4px;
            border-bottom: 1px solid @color-light-gray;

            &:last-child {
                border-bottom: none;
            }

            .essence-label {
                font-weight: bold;
                color: #4a4a4a;
            }
        }
    }

    /* --------------------------------------------------------------------
       INPUTS & DERIVED STATS
       -------------------------------------------------------------------- */
    input[type="number"] {
        text-align: center;
        background: rgba(255, 255, 255, 0.5);
        border: 1px solid #7a7971;
        border-radius: 3px;

        /* Visual Logic: E_MAX is Red (Limit), E_CUR is Green (Life) */
        &.input-emax {
            color: @color-emax;
            font-weight: bold;
        }

        &.input-ecur {
            color: @color-ecur;
            font-weight: bold;
        }
    }

    /* Read-only stats (Tier, Dice strings) */
    .derived-stat {
        text-align: center;
        background: transparent;
        border: none;
        color: #555;
        font-style: italic;
        pointer-events: none; /* Prevent user interaction */
    }

    /* --------------------------------------------------------------------
       CALCULATOR PANEL (Combat Logic)
       -------------------------------------------------------------------- */
    .roll-calculation, .execute-batch {
        cursor: pointer;
        transition: background-color 0.2s;
        
        &:hover {
            opacity: 0.9;
        }
    }
    
    .roll-calc-btn {
        background: #ddd;
        border: 1px solid #999;
        border-radius: 3px;
        padding: 0 5px;
        cursor: pointer;
        color: #333;
        
        &:hover {
            background: #ccc;
            color: #000;
        }
    }

    /* --------------------------------------------------------------------
       ITEMS & INVENTORY
       -------------------------------------------------------------------- */
    .items-list {
        list-style: none;
        margin: 0;
        padding: 0;
        
        .item-header {
            background: rgba(0,0,0,0.05);
            border: 1px solid #aaa;
            font-weight: bold;
            padding: 5px;
        }
        
        .item {
            padding: 5px;
            border-bottom: 1px solid #ccc;
            background: rgba(255,255,255,0.2);
            
            .item-image {
                flex: 0 0 24px;
                margin-right: 5px;
                img { border: none; }
            }
            
            .item-name {
                flex: 1;
                margin: 0;
                line-height: 24px;
                
                /* Rollable Item Link */
                .rollable {
                    color: #333;
                    &:hover { color: #000; text-shadow: 0 0 2px #fff; }
                }
            }
            
            .item-controls {
                flex: 0 0 50px;
                text-align: right;
                a { margin-left: 5px; color: #555; }
            }
        }
    }

    /* --------------------------------------------------------------------
       THEME OVERRIDES: PC (Green) vs NPC (Red)
       -------------------------------------------------------------------- */
    
    /* PC Theme: Growth, Life, Heroism */
    form.character {
        background-color: @theme-pc-bg !important;

        header.sheet-header {
            border-bottom-color: @theme-pc-border;
        }

        .profile-img {
            border-color: @theme-pc-border;
            background-color: #1a4d1a; /* Dark Green bg behind image */
        }

        .essence-header {
            border-bottom-color: @theme-pc-border;
            color: @theme-pc-border;
        }
        
        .derived-stat {
            color: #004d00;
        }
    }

    /* NPC Theme: Threat, Blood, Adversity */
    form.npc {
        background-color: @theme-npc-bg !important;

        header.sheet-header {
            border-bottom-color: @theme-npc-border;
        }

        .profile-img {
            border-color: @theme-npc-border;
            background-color: #4d1a1a; /* Dark Red bg behind image */
        }

        .essence-header {
            border-bottom-color: @theme-npc-border;
            color: @theme-npc-border;
        }
        
        /* Highlight the calculator in NPC sheets for GM visibility */
        .tab.essences .essence-grid-container:nth-child(2) {
            background: rgba(139, 0, 0, 0.05);
            border-color: @theme-npc-border;
        }

        .derived-stat {
            color: #4d0000;
        }
    }
}

###############################################################################
##                                                                          ###
##                               package.json                               ###
##                                                                          ###
###############################################################################

{
  "name": "narequenta",
  "version": "0.9.16",
  "description": "Nárëquenta — Tales of the Waning (Foundry VTT System)",
  "scripts": {
    "css": "gulp css",
    "watch": "gulp",
    "gulp": "gulp"
  },
  "repository": {
    "type": "git",
    "url": "git+https://github.com/cortonemo/narequenta-vtt.git"
  },
  "browserslist": [
    "last 3 versions"
  ],
  "author": "Serelith Varn",
  "license": "SEE LICENSE IN LICENSE.md",
  "private": true,
  "dependencies": {
    "gulp": "^4.0.2",
    "gulp-less": "^4.0.1"
  },
  "devDependencies": {}
}

###############################################################################
##                                                                          ###
##                                 pt.json                                  ###
##                                                                          ###
###############################################################################

{
  "NAREQUENTA.GameTitle": "Nárëquenta: Contos do Declínio",

  "SETTINGS.SimpleMacroShorthandN": "Sintaxe de Macro Abreviada",
  "SETTINGS.SimpleMacroShorthandL": "Ativar sintaxe abreviada. Permite referenciar essências diretamente, por exemplo @vitalis em vez de @essences.vitalis.value.",
  "SETTINGS.SimpleInitFormulaN": "Fórmula de Iniciativa",
  "SETTINGS.SimpleInitFormulaL": "Insira uma fórmula de iniciativa. Recomendado: 1d10 + @essences.sensus.tier",

  "NAREQUENTA.ItemCreate": "Criar Habilidade",
  "NAREQUENTA.ItemEdit": "Editar Habilidade",
  "NAREQUENTA.ItemDelete": "Apagar Habilidade",
  "NAREQUENTA.ItemNew": "Nova Habilidade",

  "NAREQUENTA.NotifyInitFormulaUpdated": "Fórmula de iniciativa atualizada para",
  "NAREQUENTA.NotifyInitFormulaInvalid": "Fórmula de iniciativa inválida",

  "NAREQUENTA.Health": "Vigor Atual (PV)",
  "NAREQUENTA.EssenceMax": "Pico da Alma",
  "NAREQUENTA.EssenceCur": "Vigor Ativo",
  "NAREQUENTA.EssenceTier": "Nível / Compensação de Declínio",
  "NAREQUENTA.ActionSurges": "Surtos de Intenção",

  "NAREQUENTA.TabEssences": "Facetas do Eu",
  "NAREQUENTA.TabAbilities": "Habilidades e Equipamento",
  "NAREQUENTA.TabBiography": "A Lenda (Bio)",
  "NAREQUENTA.TabPromise": "Voto Final",

  "NAREQUENTA.Vitalis": "VITALIS (Vigor, Presença)",
  "NAREQUENTA.Motus": "MOTUS (Movimento, Finesse)",
  "NAREQUENTA.Sensus": "SENSUS (Percepção, Instinto)",
  "NAREQUENTA.Verbum": "VERBUM (Intelecto, Lógica)",
  "NAREQUENTA.Anima": "ANIMA (Vontade, Sacrifício)",

  "NAREQUENTA.DefineTemplate": "Definir como Modelo",
  "NAREQUENTA.UnsetTemplate": "Remover Modelo",
  "NAREQUENTA.NoTemplate": "Sem Modelo",

  "NAREQUENTA.Create": "Criar",
  "NAREQUENTA.New": "Novo",
  
  "NAREQUENTA.RollSuccess": "Sucesso",
  "NAREQUENTA.RollFailure": "Falha",
  "NAREQUENTA.AttritionApplied": "Atrito Aplicado (Motor/Qualidade)",

  "NAREQUENTA.AttributeKey": "Chave do Atributo",
  "NAREQUENTA.AttributeValue": "Valor",
  "NAREQUENTA.AttributeLabel": "Rótulo",
  "NAREQUENTA.AttributeDtype": "Tipo de Dados",
  "NAREQUENTA.ResourceMin": "Mín",
  "NAREQUENTA.ResourceValue": "Valor",
  "NAREQUENTA.ResourceMax": "Máx",

  "NAREQUENTA.NotifyAttrDuplicate": "Chave de atributo já existe como um grupo.",
  "NAREQUENTA.NotifyGroupDuplicate": "Grupo de atributos já existe.",
  "NAREQUENTA.NotifyGroupAttrDuplicate": "Grupo de atributos já existe como um atributo.",
  "NAREQUENTA.NotifyGroupReserved": "Grupo de atributos \"{key}\" é reservado e não pode ser usado.",
  "NAREQUENTA.NotifyGroupAlphanumeric": "Nomes de grupos de atributos não podem conter espaços ou pontos.",
  "NAREQUENTA.NotifyAttrInvalid": "Chaves de atributos não podem conter espaços ou pontos.",
  
  "NAREQUENTA.DeleteGroup": "Apagar grupo?",
  "NAREQUENTA.DeleteGroupContent": "Deseja apagar este grupo? Isto apagará o seguinte grupo e todos os atributos incluídos nele: ",
  
  "Yes": "Sim",
  "No": "Não"
}


###############################################################################
##                                                                          ###
##                                README.md                                 ###
##                                                                          ###
###############################################################################

![Repository Header Image](header_image.png)
# Nárëquenta — Tales of the Waning (Foundry VTT)

**Version: v0.9-BETA (Decay Mitigation and Tier I Stabilization)**
**Author:** Serelith Varn (cortonemo)
**License:** Nárëquenta Limited Open License (v0.1)
**Compatibility:** Foundry VTT v11+

-----

## 💡 Core Philosophy: Attrition is Meaning

Nárëquenta is a TTRPG about **Beautiful Erosion**. Heroes start at their peak and gradually fade as they act and spend their Essence. Progression is the **defining of character through loss**.

**Core Axiom (v0.9):** Power is a finite resource. The real threat is the **Extinction of Essence**. **Proficiency Compensates for Decline**, allowing maximum impact with minimal capacity.

## ⚙️ System Features

The Foundry VTT implementation automates the core math of Nárëquenta:

  * **Essence Management:** Tracks **E_max** (Permanent Potential) and **E_cur** (Daily Energy).
  * **Automated Waning Roll:** The "Trigger Waning Phase" button handles the complex logic of **Focus (2d6)** vs **Universal (1d6)** decay, including the **Tier I Guarantee** logic.
  * **Interactive Damage Calculator:** Built directly into the Character and NPC sheets to handle the **Additive Damage Formula** and **Tier Advantage Multipliers**.
  * **Localization:** Fully localized in English and Portuguese.

## 🧮 Math Reference (v0.9)

  * **Damage Formula:**
    $$\mathbf{D_{Final}} = \max \left( 0, (A_{FP} - \bar{M}_{Defense} + D_{Margin} + R_{prof}) \right) \times M_{DTA} \text{}$$

  * **Tier Sync:** * **E_max Floor:** 50%
    * **Tier I Guarantee:** First focus roll guarantees a drop to 90%.

-----

### 📦 Installation

1. Open Foundry VTT.
2. Go to **Game Systems** -> **Install System**.
3. Paste the Manifest URL: 
   `https://github.com/cortonemo/narequenta-vtt/releases/latest/download/system.json`
4. Click **Install**.

-----

### 📜 License & Authorship

**© 2025 Serelith Varn**
This project is released under the **Nárëquenta Limited Open License (v0.1)**.
You are free to play, stream, and create fan content for this system—provided you give proper credit and do not use it commercially.

This software is based on the **Simple Worldbuilding System** by Atropos, used under the MIT License.

📜 [Read the full license →](LICENSE.md)

###############################################################################
##                                                                          ###
##                          sheet-attributes.html                           ###
##                                                                          ###
###############################################################################

<section class="attributes-group">
    <ol class="attributes-list">
        {{#each attributes as |attr key|}}
        <li class="attribute flexrow" data-attribute="{{#if attr.group}}{{attr.group}}.{{/if}}{{key}}">
            <div class="attribute-key-wrapper flexrow">
                {{#if attr.isFormula}}
                    <a class="attribute-roll" data-label="{{attr.label}}" data-roll="{{attr.value}}"><i class="fas fa-dice-d20"></i></a>
                {{/if}}
                <input class="attribute-key" type="text" name="system.attributes.{{#if attr.group}}{{attr.group}}.{{/if}}{{key}}.key" value="{{key}}" placeholder="{{localize "NAREQUENTA.AttributeKey"}}"/>
            </div>
            {{!-- Handle booleans. --}}
            {{#if attr.isCheckbox}}
            <label class="attribute-value checkbox"><input type="checkbox" name="system.attributes.{{#if attr.group}}{{attr.group}}.{{/if}}{{key}}.value"
                    {{checked attr.value}} /></label>
            {{else}}
            {{!-- Handle resources. --}}
            {{#if attr.isResource}}
            <div class="attribute-group flexrow">
                <span class="attribute-col flexcol">
                    <label for="system.attributes.{{#if attr.group}}{{attr.group}}.{{/if}}{{key}}.min">{{localize "NAREQUENTA.ResourceMin"}}</label>
                    <input class="attribute-value" type="text" name="system.attributes.{{#if attr.group}}{{attr.group}}.{{/if}}{{key}}.min" value="{{attr.min}}"
                        data-dtype="Number" />
                </span>
                <span class="attribute-col flexcol">
                    <label for="system.attributes.{{#if attr.group}}{{attr.group}}.{{/if}}{{key}}.value">{{localize "NAREQUENTA.ResourceValue"}}</label>
                    <input class="attribute-value" type="text" name="system.attributes.{{#if attr.group}}{{attr.group}}.{{/if}}{{key}}.value"
                        value="{{attr.value}}" data-dtype="Number" />
                </span>
                <span class="attribute-col flexcol">
                    <label for="system.attributes.{{#if attr.group}}{{attr.group}}.{{/if}}{{key}}.max">{{localize "NAREQUENTA.ResourceMax"}}</label>
                    <input class="attribute-value" type="text" name="system.attributes.{{#if attr.group}}{{attr.group}}.{{/if}}{{key}}.max" value="{{attr.max}}"
                        data-dtype="Number" />
                </span>
            </div>
            {{!-- Handle other input types. --}}
            {{else}}
            <input class="attribute-value" type="text" name="system.attributes.{{#if attr.group}}{{attr.group}}.{{/if}}{{key}}.value" value="{{attr.value}}"
                data-dtype="{{attr.dtype}}" placeholder="{{localize "NAREQUENTA.AttributeValue"}}"/>
            {{/if}}
            {{/if}}
            <input class="attribute-label" type="text" name="system.attributes.{{#if attr.group}}{{attr.group}}.{{/if}}{{key}}.label" value="{{attr.label}}"
                placeholder="{{localize "NAREQUENTA.AttributeLabel"}}"/>
            <select class="attribute-dtype" name="system.attributes.{{#if attr.group}}{{attr.group}}.{{/if}}{{key}}.dtype">
                {{#select attr.dtype}}
                {{#each ../dtypes as |t|}}
                <option value="{{t}}">{{t}}</option>
                {{/each}}
                {{/select}}
            </select>
            <input type="hidden" name="system.attributes.{{#if attr.group}}{{attr.group}}.{{/if}}{{key}}.group" value="{{attr.group}}" />
            <a class="attribute-control" data-action="delete"><i class="fas fa-trash"></i></a>
        </li>
        {{/each}}
    </ol>
</section>

###############################################################################
##                                                                          ###
##                            sheet-groups.html                             ###
##                                                                          ###
###############################################################################

<ol class="groups-list">
    {{#each groups as |group groupKey|}}
    <li class="group" data-group="{{groupKey}}">
        <div class="group-header flexrow">
            <input class="group-key" type="text" readonly name="system.groups.{{groupKey}}.key" value="{{groupKey}}" />
            <input class="group-label" type="text" name="system.groups.{{groupKey}}.label" value="{{group.label}}" placeholder="Group Label" />
            <select class="group-dtype" name="system.groups.{{groupKey}}.dtype">
                {{#select group.dtype}}
                {{#each ../dtypes as |t|}}
                <option value="{{t}}">{{t}}</option>
                {{/each}}
                {{/select}}
            </select>
            <a class="attribute-control" data-action="create" data-group="{{groupKey}}" data-dtype="{{group.dtype}}"><i class="fas fa-plus"></i></a>
            <a class="group-control" data-action="delete-group"><i class="fas fa-trash"></i></a>
        </div>

        {{!-- FIX: Updated path from 'worldbuilding' to 'narequenta' --}}
        {{> "systems/narequenta/templates/parts/sheet-attributes.html" attributes=group.attributes group=groupKey dtypes=../dtypes}}
    </li>
    {{/each}}
</ol>

###############################################################################
##                                                                          ###
##                               system.json                                ###
##                                                                          ###
###############################################################################

{
  "id": "narequenta",
  "title": "Nárëquenta — Tales of the Waning",
  "version": "v0.9.62",
  "description": "A TTRPG about Beautiful Erosion. Heroes start at their peak and gradually fade. Power is a finite resource; Proficiency Compensates for Decline.",
  "url": "https://github.com/cortonemo/narequenta-vtt",
  "license": "LICENSE.md",
  "authors": [
    {
      "name": "Serelith Varn",
      "email": "serelith.varn@gmail.com",
      "url": "https://github.com/cortonemo"
    }
  ],
  "esmodules": ["module/narequenta.js"],
  "styles": ["styles/narequenta.css"],
  "packs": [],
  "languages": [
    {
      "lang": "en",
      "name": "English",
      "path": "lang/en.json"
    },
    {
      "lang": "pt",
      "name": "Português",
      "path": "lang/pt.json"
    }
  ],
  "compatibility": {
    "minimum": "11",
    "verified": "13"
  },
  
  "grid": {
    "distance": 5,
    "units": "ft"
  },
  
  "primaryTokenAttribute": "resources.hp",
  "secondaryTokenAttribute": "resources.action_surges",
  "manifest": "https://github.com/cortonemo/narequenta-vtt/releases/latest/download/system.json",
  "download": "https://github.com/cortonemo/narequenta-vtt/releases/latest/download/system.zip"
}


###############################################################################
##                                                                          ###
##                              template.json                               ###
##                                                                          ###
###############################################################################

{
  "Actor": {
    "types": ["character", "npc"],
    "templates": {
      "base": {
        "biography": "",
        "resources": {
          "hp": { "value": 100, "min": 0, "max": 100 }
        }
      }
    },
    "character": {
      "templates": ["base"],
      "promise": "",
      "resources": {
        "hp": { "value": 100, "min": 0, "max": 100 },
        "action_surges": { "value": 0, "min": 0, "max": 5 }
      },
     "calculator": {
        "attack_roll": null,
        "prof_roll": null,
        "defense_roll": null,
        "item_bonus": 0,
        "item_weight": 15,
        "active_motor": "vitalis",
        "active_motor_val": 0,
        "target_def_stat": "vitalis",
        "apply_to": "hp",
        "target_name": "None",
        "target_ids": [],
        "batch_data": "",
        "output": ""
      },
      "essences": {
        "vitalis": { "value": 100, "max": 100, "label": "VITALIS" },
        "motus":   { "value": 100, "max": 100, "label": "MOTUS" },
        "sensus":  { "value": 100, "max": 100, "label": "SENSUS" },
        "verbum":  { "value": 100, "max": 100, "label": "VERBUM" },
        "anima":   { "value": 100, "max": 100, "label": "ANIMA" }
      },
      "attributes": {},
      "groups": {}
    },
    "npc": {
      "templates": ["base"],
      "tier": 0,
     "calculator": {
        "attack_roll": null,
        "prof_roll": null,
        "defense_roll": null,
        "item_bonus": 0,
        "item_weight": 15,
        "active_motor": "vitalis",
        "active_motor_val": 0,
        "target_def_stat": "vitalis",
        "apply_to": "hp",
        "target_name": "None",
        "target_ids": [],
        "batch_data": "",
        "output": ""
      },
      "essences": {
        "vitalis": { "value": 100, "max": 100, "label": "VITALIS" },
        "motus":   { "value": 100, "max": 100, "label": "MOTUS" },
        "sensus":  { "value": 100, "max": 100, "label": "SENSUS" },
        "verbum":  { "value": 100, "max": 100, "label": "VERBUM" },
        "anima":   { "value": 100, "max": 100, "label": "ANIMA" }
      },
      "attributes": {},
      "groups": {}
    }
  },
  "Item": {
    "types": ["item", "ability", "weapon"],
    "htmlFields": ["description"],
    "item": {
      "description": "",
      "quantity": 1,
      "weight": 10,
      "damage_bonus": "", 
      "target_type": "one",
      "target_resource": "hp",
      "attributes": {},
      "groups": {}
    },
    "ability": {
      "description": "",
      "range": 5,
      "quantity": 1,
      "damage_bonus": "", 
      "target_type": "one",
      "target_resource": "hp",
      "cost": {
        "motor": "vitalis",
        "quality": "motus"
      },
      "attributes": {},
      "groups": {}
    },
    "weapon": {
      "description": "",
      "range": 5,
      "quantity": 1,
      "damage_bonus": "", 
      "weight": 15,
      "target_type": "one",
      "target_resource": "hp",
      "cost": {
        "motor": "vitalis",
        "quality": "motus"
      },
      "attributes": {},
      "groups": {}
    }
  }
}

###############################################################################
##                                                                          ###
##                               templates.js                               ###
##                                                                          ###
###############################################################################

export const preloadHandlebarsTemplates = async function() {
  // Define template paths to load
  // Note: You likely won't need sheet-attributes.html if you hardcode the essence grid
  // But we keep them for Item Sheets.
  const templatePaths = [
    "systems/narequenta/templates/parts/sheet-attributes.html", 
    "systems/narequenta/templates/parts/sheet-groups.html"
  ];

  return loadTemplates(templatePaths);
};

###############################################################################
##                                                                          ###
##                                 token.js                                 ###
##                                                                          ###
###############################################################################

export class SimpleTokenDocument extends TokenDocument {
  // Foundry VTT Core handles bar attributes for {value, max} objects automatically.
  // We can rely on default behavior for Nárëquenta Essences.
}

export class SimpleToken extends Token {
  // Keep default bar drawing
}